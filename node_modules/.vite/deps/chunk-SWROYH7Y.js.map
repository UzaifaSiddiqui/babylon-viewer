{
  "version": 3,
  "sources": ["../../../dev/loaders/src/glTF/2.0/Extensions/KHR_draco_mesh_compression.ts"],
  "sourcesContent": ["/* eslint-disable github/no-then */\r\nimport { DracoDecoder } from \"core/Meshes/Compression/dracoDecoder\";\r\nimport type { Nullable } from \"core/types\";\r\nimport { VertexBuffer } from \"core/Buffers/buffer\";\r\nimport type { Geometry } from \"core/Meshes/geometry\";\r\nimport type { Mesh } from \"core/Meshes/mesh\";\r\n\r\nimport { MeshPrimitiveMode } from \"babylonjs-gltf2interface\";\r\nimport type { IKHRDracoMeshCompression } from \"babylonjs-gltf2interface\";\r\nimport type { IMeshPrimitive, IBufferView } from \"../glTFLoaderInterfaces\";\r\nimport type { IGLTFLoaderExtension } from \"../glTFLoaderExtension\";\r\nimport { GLTFLoader, ArrayItem, LoadBoundingInfoFromPositionAccessor } from \"../glTFLoader\";\r\nimport { registerGLTFExtension, unregisterGLTFExtension } from \"../glTFLoaderExtensionRegistry\";\r\n\r\nconst NAME = \"KHR_draco_mesh_compression\";\r\n\r\ndeclare module \"../../glTFFileLoader\" {\r\n    // eslint-disable-next-line jsdoc/require-jsdoc, @typescript-eslint/naming-convention\r\n    export interface GLTFLoaderExtensionOptions {\r\n        /**\r\n         * Defines options for the KHR_draco_mesh_compression extension.\r\n         */\r\n        // NOTE: Don't use NAME here as it will break the UMD type declarations.\r\n        [\"KHR_draco_mesh_compression\"]: {};\r\n    }\r\n}\r\n\r\ninterface IBufferViewDraco extends IBufferView {\r\n    _dracoBabylonGeometry?: Promise<Geometry>;\r\n}\r\n\r\n/**\r\n * [Specification](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Khronos/KHR_draco_mesh_compression/README.md)\r\n */\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport class KHR_draco_mesh_compression implements IGLTFLoaderExtension {\r\n    /**\r\n     * The name of this extension.\r\n     */\r\n    public readonly name = NAME;\r\n\r\n    /**\r\n     * The draco decoder used to decode vertex data or DracoDecoder.Default if not defined\r\n     */\r\n    public dracoDecoder?: DracoDecoder;\r\n\r\n    /**\r\n     * Defines whether this extension is enabled.\r\n     */\r\n    public enabled: boolean;\r\n\r\n    /**\r\n     * Defines whether to use the normalized flag from the glTF accessor instead of the Draco data. Defaults to true.\r\n     */\r\n    public useNormalizedFlagFromAccessor = true;\r\n\r\n    private _loader: GLTFLoader;\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    constructor(loader: GLTFLoader) {\r\n        this._loader = loader;\r\n        this.enabled = DracoDecoder.DefaultAvailable && this._loader.isExtensionUsed(NAME);\r\n    }\r\n\r\n    /** @internal */\r\n    public dispose(): void {\r\n        delete this.dracoDecoder;\r\n        (this._loader as any) = null;\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    // eslint-disable-next-line no-restricted-syntax\r\n    public _loadVertexDataAsync(context: string, primitive: IMeshPrimitive, babylonMesh: Mesh): Nullable<Promise<Geometry>> {\r\n        return GLTFLoader.LoadExtensionAsync<IKHRDracoMeshCompression, Geometry>(context, primitive, this.name, async (extensionContext, extension) => {\r\n            if (primitive.mode != undefined) {\r\n                if (primitive.mode !== MeshPrimitiveMode.TRIANGLES && primitive.mode !== MeshPrimitiveMode.TRIANGLE_STRIP) {\r\n                    throw new Error(`${context}: Unsupported mode ${primitive.mode}`);\r\n                }\r\n            }\r\n\r\n            const attributes: { [kind: string]: number } = {};\r\n            const normalized: { [kind: string]: boolean } = {};\r\n            const loadAttribute = (name: string, kind: string) => {\r\n                const uniqueId = extension.attributes[name];\r\n                if (uniqueId == undefined) {\r\n                    return;\r\n                }\r\n\r\n                babylonMesh._delayInfo = babylonMesh._delayInfo || [];\r\n                if (babylonMesh._delayInfo.indexOf(kind) === -1) {\r\n                    babylonMesh._delayInfo.push(kind);\r\n                }\r\n\r\n                attributes[kind] = uniqueId;\r\n\r\n                if (this.useNormalizedFlagFromAccessor) {\r\n                    const accessor = ArrayItem.TryGet(this._loader.gltf.accessors, primitive.attributes[name]);\r\n                    if (accessor) {\r\n                        normalized[kind] = accessor.normalized || false;\r\n                    }\r\n                }\r\n            };\r\n\r\n            loadAttribute(\"POSITION\", VertexBuffer.PositionKind);\r\n            loadAttribute(\"NORMAL\", VertexBuffer.NormalKind);\r\n            loadAttribute(\"TANGENT\", VertexBuffer.TangentKind);\r\n            loadAttribute(\"TEXCOORD_0\", VertexBuffer.UVKind);\r\n            loadAttribute(\"TEXCOORD_1\", VertexBuffer.UV2Kind);\r\n            loadAttribute(\"TEXCOORD_2\", VertexBuffer.UV3Kind);\r\n            loadAttribute(\"TEXCOORD_3\", VertexBuffer.UV4Kind);\r\n            loadAttribute(\"TEXCOORD_4\", VertexBuffer.UV5Kind);\r\n            loadAttribute(\"TEXCOORD_5\", VertexBuffer.UV6Kind);\r\n            loadAttribute(\"JOINTS_0\", VertexBuffer.MatricesIndicesKind);\r\n            loadAttribute(\"WEIGHTS_0\", VertexBuffer.MatricesWeightsKind);\r\n            loadAttribute(\"COLOR_0\", VertexBuffer.ColorKind);\r\n\r\n            const bufferView = ArrayItem.Get(extensionContext, this._loader.gltf.bufferViews, extension.bufferView) as IBufferViewDraco;\r\n            if (!bufferView._dracoBabylonGeometry) {\r\n                bufferView._dracoBabylonGeometry = this._loader.loadBufferViewAsync(`/bufferViews/${bufferView.index}`, bufferView).then(async (data) => {\r\n                    const dracoDecoder = this.dracoDecoder || DracoDecoder.Default;\r\n                    const positionAccessor = ArrayItem.TryGet(this._loader.gltf.accessors, primitive.attributes[\"POSITION\"]);\r\n                    const babylonBoundingInfo =\r\n                        !this._loader.parent.alwaysComputeBoundingBox && !babylonMesh.skeleton && positionAccessor ? LoadBoundingInfoFromPositionAccessor(positionAccessor) : null;\r\n                    return await dracoDecoder\r\n                        ._decodeMeshToGeometryForGltfAsync(babylonMesh.name, this._loader.babylonScene, data, attributes, normalized, babylonBoundingInfo)\r\n                        .catch((error) => {\r\n                            throw new Error(`${context}: ${error.message}`);\r\n                        });\r\n                });\r\n            }\r\n\r\n            return await bufferView._dracoBabylonGeometry;\r\n        });\r\n    }\r\n}\r\n\r\nunregisterGLTFExtension(NAME);\r\nregisterGLTFExtension(NAME, true, (loader) => new KHR_draco_mesh_compression(loader));\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAcA,IAAM,OAAO;AAqBP,IAAO,6BAAP,MAAiC;;;;EA0BnC,YAAY,QAAkB;AAtBd,SAAA,OAAO;AAehB,SAAA,gCAAgC;AAQnC,SAAK,UAAU;AACf,SAAK,UAAU,aAAa,oBAAoB,KAAK,QAAQ,gBAAgB,IAAI;EACrF;;EAGO,UAAO;AACV,WAAO,KAAK;AACX,SAAK,UAAkB;EAC5B;;;;;EAMO,qBAAqB,SAAiB,WAA2B,aAAiB;AACrF,WAAO,WAAW,mBAAuD,SAAS,WAAW,KAAK,MAAM,OAAO,kBAAkB,cAAa;AAC1I,UAAI,UAAU,QAAQ,QAAW;AAC7B,YAAI,UAAU,SAAI,KAAoC,UAAU,SAAI,GAAuC;AACvG,gBAAM,IAAI,MAAM,GAAG,OAAO,sBAAsB,UAAU,IAAI,EAAE;QACpE;MACJ;AAEA,YAAM,aAAyC,CAAA;AAC/C,YAAM,aAA0C,CAAA;AAChD,YAAM,gBAAgB,CAAC,MAAc,SAAgB;AACjD,cAAM,WAAW,UAAU,WAAW,IAAI;AAC1C,YAAI,YAAY,QAAW;AACvB;QACJ;AAEA,oBAAY,aAAa,YAAY,cAAc,CAAA;AACnD,YAAI,YAAY,WAAW,QAAQ,IAAI,MAAM,IAAI;AAC7C,sBAAY,WAAW,KAAK,IAAI;QACpC;AAEA,mBAAW,IAAI,IAAI;AAEnB,YAAI,KAAK,+BAA+B;AACpC,gBAAM,WAAW,UAAU,OAAO,KAAK,QAAQ,KAAK,WAAW,UAAU,WAAW,IAAI,CAAC;AACzF,cAAI,UAAU;AACV,uBAAW,IAAI,IAAI,SAAS,cAAc;UAC9C;QACJ;MACJ;AAEA,oBAAc,YAAY,aAAa,YAAY;AACnD,oBAAc,UAAU,aAAa,UAAU;AAC/C,oBAAc,WAAW,aAAa,WAAW;AACjD,oBAAc,cAAc,aAAa,MAAM;AAC/C,oBAAc,cAAc,aAAa,OAAO;AAChD,oBAAc,cAAc,aAAa,OAAO;AAChD,oBAAc,cAAc,aAAa,OAAO;AAChD,oBAAc,cAAc,aAAa,OAAO;AAChD,oBAAc,cAAc,aAAa,OAAO;AAChD,oBAAc,YAAY,aAAa,mBAAmB;AAC1D,oBAAc,aAAa,aAAa,mBAAmB;AAC3D,oBAAc,WAAW,aAAa,SAAS;AAE/C,YAAM,aAAa,UAAU,IAAI,kBAAkB,KAAK,QAAQ,KAAK,aAAa,UAAU,UAAU;AACtG,UAAI,CAAC,WAAW,uBAAuB;AACnC,mBAAW,wBAAwB,KAAK,QAAQ,oBAAoB,gBAAgB,WAAW,KAAK,IAAI,UAAU,EAAE,KAAK,OAAO,SAAQ;AACpI,gBAAM,eAAe,KAAK,gBAAgB,aAAa;AACvD,gBAAM,mBAAmB,UAAU,OAAO,KAAK,QAAQ,KAAK,WAAW,UAAU,WAAW,UAAU,CAAC;AACvG,gBAAM,sBACF,CAAC,KAAK,QAAQ,OAAO,4BAA4B,CAAC,YAAY,YAAY,mBAAmB,qCAAqC,gBAAgB,IAAI;AAC1J,iBAAO,MAAM,aACR,kCAAkC,YAAY,MAAM,KAAK,QAAQ,cAAc,MAAM,YAAY,YAAY,mBAAmB,EAChI,MAAM,CAAC,UAAS;AACb,kBAAM,IAAI,MAAM,GAAG,OAAO,KAAK,MAAM,OAAO,EAAE;UAClD,CAAC;QACT,CAAC;MACL;AAEA,aAAO,MAAM,WAAW;IAC5B,CAAC;EACL;;AAGJ,wBAAwB,IAAI;AAC5B,sBAAsB,MAAM,MAAM,CAAC,WAAW,IAAI,2BAA2B,MAAM,CAAC;",
  "names": []
}
