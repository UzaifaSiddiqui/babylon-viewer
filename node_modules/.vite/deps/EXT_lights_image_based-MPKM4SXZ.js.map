{
  "version": 3,
  "sources": ["../../../dev/loaders/src/glTF/2.0/Extensions/EXT_lights_image_based.ts"],
  "sourcesContent": ["import type { Nullable } from \"core/types\";\r\nimport { SphericalHarmonics, SphericalPolynomial } from \"core/Maths/sphericalPolynomial\";\r\nimport { Quaternion, Matrix } from \"core/Maths/math.vector\";\r\nimport type { BaseTexture } from \"core/Materials/Textures/baseTexture\";\r\nimport { RawCubeTexture } from \"core/Materials/Textures/rawCubeTexture\";\r\n\r\nimport type { IEXTLightsImageBased_LightReferenceImageBased, IEXTLightsImageBased_LightImageBased, IEXTLightsImageBased } from \"babylonjs-gltf2interface\";\r\nimport type { IScene } from \"../glTFLoaderInterfaces\";\r\nimport type { IGLTFLoaderExtension } from \"../glTFLoaderExtension\";\r\nimport { GLTFLoader, ArrayItem } from \"../glTFLoader\";\r\nimport { registerGLTFExtension, unregisterGLTFExtension } from \"../glTFLoaderExtensionRegistry\";\r\n\r\nconst NAME = \"EXT_lights_image_based\";\r\n\r\ndeclare module \"../../glTFFileLoader\" {\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    export interface GLTFLoaderExtensionOptions {\r\n        /**\r\n         * Defines options for the EXT_lights_image_based extension.\r\n         */\r\n        // NOTE: Don't use NAME here as it will break the UMD type declarations.\r\n        [\"EXT_lights_image_based\"]: {};\r\n    }\r\n}\r\n\r\ndeclare module \"babylonjs-gltf2interface\" {\r\n    /** @internal */\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    interface IEXTLightsImageBased_LightImageBased {\r\n        _babylonTexture?: BaseTexture;\r\n        _loaded?: Promise<void>;\r\n    }\r\n}\r\n\r\n/**\r\n * [Specification](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Vendor/EXT_lights_image_based/README.md)\r\n */\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport class EXT_lights_image_based implements IGLTFLoaderExtension {\r\n    /**\r\n     * The name of this extension.\r\n     */\r\n    public readonly name = NAME;\r\n\r\n    /**\r\n     * Defines whether this extension is enabled.\r\n     */\r\n    public enabled: boolean;\r\n\r\n    private _loader: GLTFLoader;\r\n    private _lights?: IEXTLightsImageBased_LightImageBased[];\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    constructor(loader: GLTFLoader) {\r\n        this._loader = loader;\r\n        this.enabled = this._loader.isExtensionUsed(NAME);\r\n    }\r\n\r\n    /** @internal */\r\n    public dispose() {\r\n        (this._loader as any) = null;\r\n        delete this._lights;\r\n    }\r\n\r\n    /** @internal */\r\n    public onLoading(): void {\r\n        const extensions = this._loader.gltf.extensions;\r\n        if (extensions && extensions[this.name]) {\r\n            const extension = extensions[this.name] as IEXTLightsImageBased;\r\n            this._lights = extension.lights;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    // eslint-disable-next-line no-restricted-syntax\r\n    public loadSceneAsync(context: string, scene: IScene): Nullable<Promise<void>> {\r\n        return GLTFLoader.LoadExtensionAsync<IEXTLightsImageBased_LightReferenceImageBased>(context, scene, this.name, async (extensionContext, extension) => {\r\n            this._loader._allMaterialsDirtyRequired = true;\r\n\r\n            const promises = new Array<Promise<any>>();\r\n\r\n            promises.push(this._loader.loadSceneAsync(context, scene));\r\n\r\n            this._loader.logOpen(`${extensionContext}`);\r\n\r\n            const light = ArrayItem.Get(`${extensionContext}/light`, this._lights, extension.light);\r\n            promises.push(\r\n                // eslint-disable-next-line github/no-then\r\n                this._loadLightAsync(`/extensions/${this.name}/lights/${extension.light}`, light).then((texture) => {\r\n                    this._loader.babylonScene.environmentTexture = texture;\r\n                })\r\n            );\r\n\r\n            this._loader.logClose();\r\n\r\n            // eslint-disable-next-line github/no-then\r\n            return await Promise.all(promises).then(() => {});\r\n        });\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/promise-function-async, no-restricted-syntax\r\n    private _loadLightAsync(context: string, light: IEXTLightsImageBased_LightImageBased): Promise<BaseTexture> {\r\n        if (!light._loaded) {\r\n            const promises = new Array<Promise<any>>();\r\n\r\n            this._loader.logOpen(`${context}`);\r\n\r\n            const imageData = new Array<Array<ArrayBufferView>>(light.specularImages.length);\r\n            for (let mipmap = 0; mipmap < light.specularImages.length; mipmap++) {\r\n                const faces = light.specularImages[mipmap];\r\n                imageData[mipmap] = new Array<ArrayBufferView>(faces.length);\r\n                for (let face = 0; face < faces.length; face++) {\r\n                    const specularImageContext = `${context}/specularImages/${mipmap}/${face}`;\r\n                    this._loader.logOpen(`${specularImageContext}`);\r\n\r\n                    const index = faces[face];\r\n                    const image = ArrayItem.Get(specularImageContext, this._loader.gltf.images, index);\r\n                    promises.push(\r\n                        // eslint-disable-next-line github/no-then\r\n                        this._loader.loadImageAsync(`/images/${index}`, image).then((data) => {\r\n                            imageData[mipmap][face] = data;\r\n                        })\r\n                    );\r\n\r\n                    this._loader.logClose();\r\n                }\r\n            }\r\n\r\n            this._loader.logClose();\r\n\r\n            // eslint-disable-next-line github/no-then\r\n            light._loaded = Promise.all(promises).then(async () => {\r\n                const babylonTexture = new RawCubeTexture(this._loader.babylonScene, null, light.specularImageSize);\r\n                babylonTexture.name = light.name || \"environment\";\r\n                light._babylonTexture = babylonTexture;\r\n\r\n                if (light.intensity != undefined) {\r\n                    babylonTexture.level = light.intensity;\r\n                }\r\n\r\n                if (light.rotation) {\r\n                    let rotation = Quaternion.FromArray(light.rotation);\r\n\r\n                    // Invert the rotation so that positive rotation is counter-clockwise.\r\n                    if (!this._loader.babylonScene.useRightHandedSystem) {\r\n                        rotation = Quaternion.Inverse(rotation);\r\n                    }\r\n\r\n                    Matrix.FromQuaternionToRef(rotation, babylonTexture.getReflectionTextureMatrix());\r\n                }\r\n\r\n                if (!light.irradianceCoefficients) {\r\n                    throw new Error(`${context}: Irradiance coefficients are missing`);\r\n                }\r\n\r\n                const sphericalHarmonics = SphericalHarmonics.FromArray(light.irradianceCoefficients);\r\n                sphericalHarmonics.scaleInPlace(light.intensity);\r\n\r\n                sphericalHarmonics.convertIrradianceToLambertianRadiance();\r\n                const sphericalPolynomial = SphericalPolynomial.FromHarmonics(sphericalHarmonics);\r\n\r\n                // Compute the lod generation scale to fit exactly to the number of levels available.\r\n                const lodGenerationScale = (imageData.length - 1) / Math.log2(light.specularImageSize);\r\n                return await babylonTexture.updateRGBDAsync(imageData, sphericalPolynomial, lodGenerationScale);\r\n            });\r\n        }\r\n\r\n        // eslint-disable-next-line github/no-then\r\n        return light._loaded.then(() => {\r\n            return light._babylonTexture!;\r\n        });\r\n    }\r\n}\r\n\r\nunregisterGLTFExtension(NAME);\r\nregisterGLTFExtension(NAME, true, (loader) => new EXT_lights_image_based(loader));\r\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAYA,IAAM,OAAO;AA0BP,IAAO,yBAAP,MAA6B;;;;EAiB/B,YAAY,QAAkB;AAbd,SAAA,OAAO;AAcnB,SAAK,UAAU;AACf,SAAK,UAAU,KAAK,QAAQ,gBAAgB,IAAI;EACpD;;EAGO,UAAO;AACT,SAAK,UAAkB;AACxB,WAAO,KAAK;EAChB;;EAGO,YAAS;AACZ,UAAM,aAAa,KAAK,QAAQ,KAAK;AACrC,QAAI,cAAc,WAAW,KAAK,IAAI,GAAG;AACrC,YAAM,YAAY,WAAW,KAAK,IAAI;AACtC,WAAK,UAAU,UAAU;IAC7B;EACJ;;;;;EAMO,eAAe,SAAiB,OAAa;AAChD,WAAO,WAAW,mBAAkE,SAAS,OAAO,KAAK,MAAM,OAAO,kBAAkB,cAAa;AACjJ,WAAK,QAAQ,6BAA6B;AAE1C,YAAM,WAAW,IAAI,MAAK;AAE1B,eAAS,KAAK,KAAK,QAAQ,eAAe,SAAS,KAAK,CAAC;AAEzD,WAAK,QAAQ,QAAQ,GAAG,gBAAgB,EAAE;AAE1C,YAAM,QAAQ,UAAU,IAAI,GAAG,gBAAgB,UAAU,KAAK,SAAS,UAAU,KAAK;AACtF,eAAS;;QAEL,KAAK,gBAAgB,eAAe,KAAK,IAAI,WAAW,UAAU,KAAK,IAAI,KAAK,EAAE,KAAK,CAAC,YAAW;AAC/F,eAAK,QAAQ,aAAa,qBAAqB;QACnD,CAAC;MAAC;AAGN,WAAK,QAAQ,SAAQ;AAGrB,aAAO,MAAM,QAAQ,IAAI,QAAQ,EAAE,KAAK,MAAK;MAAE,CAAC;IACpD,CAAC;EACL;;EAGQ,gBAAgB,SAAiB,OAA2C;AAChF,QAAI,CAAC,MAAM,SAAS;AAChB,YAAM,WAAW,IAAI,MAAK;AAE1B,WAAK,QAAQ,QAAQ,GAAG,OAAO,EAAE;AAEjC,YAAM,YAAY,IAAI,MAA8B,MAAM,eAAe,MAAM;AAC/E,eAAS,SAAS,GAAG,SAAS,MAAM,eAAe,QAAQ,UAAU;AACjE,cAAM,QAAQ,MAAM,eAAe,MAAM;AACzC,kBAAU,MAAM,IAAI,IAAI,MAAuB,MAAM,MAAM;AAC3D,iBAAS,OAAO,GAAG,OAAO,MAAM,QAAQ,QAAQ;AAC5C,gBAAM,uBAAuB,GAAG,OAAO,mBAAmB,MAAM,IAAI,IAAI;AACxE,eAAK,QAAQ,QAAQ,GAAG,oBAAoB,EAAE;AAE9C,gBAAM,QAAQ,MAAM,IAAI;AACxB,gBAAM,QAAQ,UAAU,IAAI,sBAAsB,KAAK,QAAQ,KAAK,QAAQ,KAAK;AACjF,mBAAS;;YAEL,KAAK,QAAQ,eAAe,WAAW,KAAK,IAAI,KAAK,EAAE,KAAK,CAAC,SAAQ;AACjE,wBAAU,MAAM,EAAE,IAAI,IAAI;YAC9B,CAAC;UAAC;AAGN,eAAK,QAAQ,SAAQ;QACzB;MACJ;AAEA,WAAK,QAAQ,SAAQ;AAGrB,YAAM,UAAU,QAAQ,IAAI,QAAQ,EAAE,KAAK,YAAW;AAClD,cAAM,iBAAiB,IAAI,eAAe,KAAK,QAAQ,cAAc,MAAM,MAAM,iBAAiB;AAClG,uBAAe,OAAO,MAAM,QAAQ;AACpC,cAAM,kBAAkB;AAExB,YAAI,MAAM,aAAa,QAAW;AAC9B,yBAAe,QAAQ,MAAM;QACjC;AAEA,YAAI,MAAM,UAAU;AAChB,cAAI,WAAW,WAAW,UAAU,MAAM,QAAQ;AAGlD,cAAI,CAAC,KAAK,QAAQ,aAAa,sBAAsB;AACjD,uBAAW,WAAW,QAAQ,QAAQ;UAC1C;AAEA,iBAAO,oBAAoB,UAAU,eAAe,2BAA0B,CAAE;QACpF;AAEA,YAAI,CAAC,MAAM,wBAAwB;AAC/B,gBAAM,IAAI,MAAM,GAAG,OAAO,uCAAuC;QACrE;AAEA,cAAM,qBAAqB,mBAAmB,UAAU,MAAM,sBAAsB;AACpF,2BAAmB,aAAa,MAAM,SAAS;AAE/C,2BAAmB,sCAAqC;AACxD,cAAM,sBAAsB,oBAAoB,cAAc,kBAAkB;AAGhF,cAAM,sBAAsB,UAAU,SAAS,KAAK,KAAK,KAAK,MAAM,iBAAiB;AACrF,eAAO,MAAM,eAAe,gBAAgB,WAAW,qBAAqB,kBAAkB;MAClG,CAAC;IACL;AAGA,WAAO,MAAM,QAAQ,KAAK,MAAK;AAC3B,aAAO,MAAM;IACjB,CAAC;EACL;;AAGJ,wBAAwB,IAAI;AAC5B,sBAAsB,MAAM,MAAM,CAAC,WAAW,IAAI,uBAAuB,MAAM,CAAC;",
  "names": []
}
