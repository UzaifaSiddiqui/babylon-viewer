!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("dae_loader",["babylonjs"],t):"object"==typeof exports?exports.dae_loader=t(require("babylonjs")):e.dae_loader=t(e.BABYLON)}(this,(e=>(()=>{"use strict";var t={43:t=>{t.exports=e}},r={};function n(e){var a=r[e];if(void 0!==a)return a.exports;var i=r[e]={exports:{}};return t[e](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};n.r(a),n.d(a,{DAEFileLoader:()=>Tt,Register:()=>_t});var i,s=n(43);class o{constructor(e){this.log=e}isInstanceOf(e,t){return e._className.indexOf("|"+t+"|")>-1}}!function(e){e[e.Debug=1]="Debug",e[e.Trace=2]="Trace",e[e.Info=3]="Info",e[e.Warning=4]="Warning",e[e.Error=5]="Error",e[e.Exception=6]="Exception"}(i||(i={}));class l{constructor(){this.onmessage=void 0}write(e,t){this.onmessage&&this.onmessage(e,t)}}class c{constructor(){}write(e,t){console.log(function(e){switch(e){case i.Debug:return"DEBUG";case i.Trace:return"TRACE";case i.Info:return"INFO";case i.Warning:return"WARNING";case i.Error:return"ERROR";case i.Exception:return"EXCEPTION";default:return"OTHER"}}(t)+": "+e)}}class u{constructor(e,t){this.log=e,this.level=t}write(e,t){t>this.level&&this.log.write(e,t)}}class d{constructor(){this.url=""}getUrl(){throw new Error("not implemented")}resolve(e){throw new Error("not implemented")}}class h extends d{constructor(e){super(),this.url=e.trim().replace(/^#/,"")}getUrl(){return this.url}resolve(e){var t=e.ids[this.url];null!=t?this.target=t:e.log?.write("Could not find URL target with URL "+this.url,i.Warning)}}class m extends d{constructor(e,t){super(),this.url=e,this.scope=t}getUrl(){return this.url}resolve(e){for(var t=this.scope,r=void 0;null==r&&t;)r=t.fxChildren[this.url],t=t.fxParent;r?this.target=r:e.log?.write("Could not find FX target with URL "+this.url,i.Warning)}}class p extends d{constructor(e,t){super(),this.url=e,this.parentId=t,this.sids=[],this.indices=[],this.dotSyntax=!1,this.arrSyntax=!1,this._parseUrl()}getUrl(){return this.url}_parseUrl(){var e=this.url.split("/");for(this.id=e.shift(),"."===this.id&&(this.id=this.parentId);e.length>1;)(t=e.shift())&&this.sids.push();if(e.length>0){var t,r=e[0],n=r.indexOf(".")>=0,a=r.indexOf("(")>=0;if(n)(t=(e=r.split(".")).shift())&&this.sids?.push(t),this.member=e.shift(),this.dotSyntax=!0;else if(a){var i,s=r.split("("),o=s.shift();o&&this.sids.push(o),this.indices=[];for(var l=0,c=s.length;l<c;l++)i=s[l],this.indices.push(parseInt(i.replace(/\)/,""),10));this.arrSyntax=!0}else this.sids.push(r)}}static findSidTarget(e,t,r,n){var a={result:void 0,warning:void 0};if(null==t)return a.result=void 0,a.warning="Could not resolve SID target "+r.join("/")+", missing root element",a;for(var i=t,s=void 0,o=0,l=r.length;o<l;o++){for(var c=r[o],u=[i];0!==u.length;){var d=u.shift();if(d){if(d.sid===c){s=d;break}var h=d.sidChildren;if(null!=h)for(var m=0,p=h.length;m<p;m++){var g=h[m];u.push(g)}}}if(!s)return a.result=void 0,a.warning="Could not resolve SID target "+r.join("/")+", missing SID part "+c,a;i=s}return a.result=s,a.warning="",a}resolve(e){var t;if(null!=this.id)if(null!=(t=e.ids[this.id])){var r=p.findSidTarget(this.url,t,this.sids,e);r.warning&&e.log?.write(r.warning,i.Warning),this.target=r.result}else e.log?.write("Could not resolve SID #"+this.url+", could not find root element "+this.id,i.Warning);else e.log?.write("Could not resolve SID #"+this.url+", link has no root ID",i.Warning)}}class g extends o{constructor(e){super(e),this.totalBytes=0,this.loadedBytes=0,this.ids={},this.links=[]}getAttributeNamed(e,t){return e.getAttributeNode(t)||void 0}getAttributeFromChildNodesNamed(e,t){e.forEach((e=>{var r=this.getAttributeNamed(e,t);if(r)return r}))}getTextContent(e){return e.textContent||e.firstChild.getNodeValue()+""}getFloatsContent(e){return this.strToFloats(this.getTextContent(e))}getFloatContent(e){return parseFloat(this.getTextContent(e))}getIntsContent(e){return this.strToInts(this.getTextContent(e))}getUintsContent(e){return this.strToUints(this.getTextContent(e))}getIntContent(e){return parseInt(this.getTextContent(e),10)}getBoolsContent(e){return this.strToBools(this.getTextContent(e))}getStringsContent(e){return this.strToStrings(this.getTextContent(e))}getAttributeAsFloat(e,t,r,n){var a=this.getAttributeFromChildNodesNamed(e.childNodes,t);return a?parseFloat(a.value):n?(this.log?.write("Element "+e.nodeName+" is missing required float attribute "+t+". Using default value "+r+".",i.Error),r):r}getAttributeAsInt(e,t,r,n){var a=this.getAttributeNamed(e,t);return a?parseInt(a.value,10):n?(this.log?.write("Element "+e.nodeName+" is missing required integer attribute "+t+". Using default value "+r+".",i.Error),r):r}getAttributeAsString(e,t,r,n){var a=this.getAttributeNamed(e,t);return a?a.value+"":n?(this.log?.write("Element "+e.nodeName+" is missing required string attribute "+t+". Using default value "+r+".",i.Error),r||""):r||""}createUrlLink(e){var t=new h(e);return this.links?.push(t),t}createSidLink(e,t){var r=new p(e,t);return this.links?.push(r),r}createFxLink(e,t){var r=new m(e,t);return this.links?.push(r),r}getAttributeAsUrlLink(e,t,r){var n=this.getAttributeNamed(e,t);return n?this.createUrlLink(n.value):r?void this.log?.write("Element "+e.nodeName+" is missing required URL link attribute "+t+".",i.Error):void 0}getAttributeAsSidLink(e,t,r,n){var a=this.getAttributeNamed(e,t);return a?this.createSidLink(a.value,r):n?void this.log?.write("Element "+e.nodeName+" is missing required SID link attribute "+t+".",i.Error):void 0}getAttributeAsFxLink(e,t,r,n){var a=this.getAttributeNamed(e,t);return a?this.createFxLink(a.value,r):n?void this.log?.write("Element "+e.nodeName+" is missing required FX link attribute "+t+".",i.Error):void 0}strToStrings(e){return e.length>0?e.trim().split(/\s+/):[]}strToFloats(e){for(var t=this.strToStrings(e),r=new Float32Array(t.length),n=t.length,a=0;a<n;++a)r[a]=parseFloat(t[a]);return r}strToInts(e){for(var t=this.strToStrings(e),r=new Int32Array(t.length),n=t.length,a=0;a<n;++a)r[a]=parseInt(t[a],10);return r}strToUints(e){for(var t=this.strToStrings(e),r=new Uint32Array(t.length),n=t.length,a=0;a<n;++a)r[a]=parseInt(t[a],10);return r}strToBools(e){for(var t=this.strToStrings(e),r=new Uint8Array(t.length),n=t.length,a=0;a<n;++a)r[a]="true"===t[a]||"1"===t[a]?1:0;return r}strToColor(e){var t=this.strToFloats(e);return 4===t.length?t:(this.log?.write("Skipped color element because it does not contain 4 numbers",i.Error),new Float32Array)}registerUrlTarget(e,t){var r=e.id;null!=r?null==this.ids[r]?this.ids[r]=e:this.log?.write("There is already an object with ID "+r+". IDs must be globally unique.",i.Error):t&&this.log?.write("Object has no ID, object was not registered as a URL target.",i.Error)}registerFxTarget(e,t){var r=e.sid;null!=r?null==t.fxChildren[r]?(e.fxParent=t,t.fxChildren[r]=e):this.log?.write("There is already an FX target with SID "+r+".",i.Error):this.log?.write("Cannot add a FX target: object has no SID.",i.Error)}registerSidTarget(e,t){t.sidChildren.push(e)}getNodePath(e){for(var t="<"+e.nodeName+">",r=1;null!=e.parentNode&&"COLLADA"!==(e=e.parentNode).nodeName.toUpperCase();){if(r>=10){t=".../"+t;break}t="<"+e.nodeName+">/"+t,r+=1}return t}reportUnexpectedChild(e){this.log?.write("Skipped unexpected element "+this.getNodePath(e)+".",i.Warning)}reportUnhandledChild(e){this.log?.write("Element "+this.getNodePath(e)+" is legal, but not handled by this loader.",i.Trace)}resolveAllLinks(){if(this.links)for(var e=this.links.length,t=0;t<e;++t)this.links[t].resolve(this)}}class f{constructor(){this.id="",this.sid="",this.name="",this.fxChildren={},this.sidChildren=[],this._className="|Element|"}static fromLink(e,t){return f._fromLink(e,"Element",t)}static _fromLink(e,t,r){return e&&e.target?r.isInstanceOf(e.target,t)?e.target:void r.log.write("Link with url "+e.url+" does not point to a "+t+", link target ignored",i.Error):void 0}}function v(e,t){for(var r=e.childNodes,n=r.length,a=0;a<n;a++){var i=r[a]||r.item(a);1===i.nodeType&&t(i)}}class b extends f{constructor(){super(),this.instance=void 0,this._className+="Scene|"}static parse(e,t){var r=new b;return v(e,(function(e){"instance_visual_scene"===e.nodeName?r.instance=t.getAttributeAsUrlLink(e,"url",!0):t.reportUnexpectedChild(e)})),r}}class w extends f{constructor(){super(),this._className+="Channel|"}static parse(e,t,r){var n=new w;return n.source=r.getAttributeAsUrlLink(e,"source",!0),n.target=r.getAttributeAsSidLink(e,"target",t.id,!0),v(e,(function(e){e.nodeName,r.reportUnexpectedChild(e)})),n}}class x extends f{constructor(){super(),this.semantic="",this.offset=0,this.set=0,this._className+="Input|"}static parse(e,t,r){var n=new x;return n.semantic=r.getAttributeAsString(e,"semantic",void 0,!0),n.source=r.getAttributeAsUrlLink(e,"source",!0),t&&(n.offset=r.getAttributeAsInt(e,"offset",0,!0),n.set=r.getAttributeAsInt(e,"set",0,!1)),n}}class k extends f{constructor(){super(),this._className+="Sampler|",this.outputs=[],this.inTangents=[],this.outTangents=[]}static fromLink(e,t){return f._fromLink(e,"Sampler",t)}static parse(e,t){var r=new k;return r.id=t.getAttributeAsString(e,"id",void 0,!1),t.registerUrlTarget(r,!1),v(e,(function(e){if("input"===e.nodeName){var n=x.parse(e,!1,t);k?.addInput(r,n,t)}else t.reportUnexpectedChild(e)})),r}static addInput(e,t,r){switch(t.semantic){case"INPUT":e.input=t;break;case"OUTPUT":e.outputs.push(t);break;case"INTERPOLATION":e.interpolation=t;break;case"IN_TANGENT":e.inTangents.push(t);break;case"OUT_TANGENT":e.outTangents.push(t);break;default:r.log.write("Unknown sampler input semantic "+t.semantic,i.Error)}}}class y extends f{constructor(){super(),this.count=0,this.stride=0,this.offset=0,this._className+="Source|",this.params={}}static fromLink(e,t){if(e)return f._fromLink(e,"Source",t)}static parse(e,t){var r=new y;return r.id=t.getAttributeAsString(e,"id",void 0,!0),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!0),v(e,(function(e){switch(e.nodeName){case"bool_array":r.sourceId=t.getAttributeAsString(e,"id",void 0,!1),r.data=t.getBoolsContent(e);break;case"float_array":r.sourceId=t.getAttributeAsString(e,"id",void 0,!1),r.data=t.getFloatsContent(e);break;case"int_array":r.sourceId=t.getAttributeAsString(e,"id",void 0,!1),r.data=t.getIntsContent(e);break;case"IDREF_array":case"Name_array":r.sourceId=t.getAttributeAsString(e,"id",void 0,!1),r.data=t.getStringsContent(e);break;case"technique_common":y.parseSourceTechniqueCommon(e,r,t);break;case"technique":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}static parseSourceTechniqueCommon(e,t,r){v(e,(function(e){"accessor"===e.nodeName?y.parseAccessor(e,t,r):r.reportUnexpectedChild(e)}))}static parseAccessor(e,t,r){var n=r.getAttributeAsString(e,"source",void 0,!0);t.count=r.getAttributeAsInt(e,"count",0,!0)||0,t.stride=r.getAttributeAsInt(e,"stride",1,!1)||0,t.offset=r.getAttributeAsInt(e,"offset",0,!1)||0,n!=="#"+t.sourceId&&r.log.write("Source "+t.id+" uses a non-local data source, this is not supported",i.Error),v(e,(function(e){"param"===e.nodeName?y.parseAccessorParam(e,t,r):r.reportUnexpectedChild(e)}))}static parseAccessorParam(e,t,r){var n=r.getAttributeAsString(e,"name",void 0,!1),a=r.getAttributeAsString(e,"semantic",void 0,!1),s=r.getAttributeAsString(e,"type",void 0,!0);r.getAttributeAsString(e,"sid",void 0,!1),null!=n&&null!=s?t.params[n]=s:null!=a&&null!=s?t.params[a]=s:null!=s?t.params["unnamed param #"+Object.keys(t.params).length]=s:r.log.write("Accessor param for source "+t.id+" ignored due to missing type",i.Warning)}}class A extends f{constructor(){super(),this._className+="Animation|",this.children=[],this.sources=[],this.samplers=[],this.channels=[]}root(){return null!=this.parent?this.parent.root():this}static parse(e,t){var r=new A;return r.id=t.getAttributeAsString(e,"id",void 0,!1),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!1),v(e,(function(e){switch(e.nodeName){case"animation":var n=A.parse(e,t);n.parent=r,r.children.push(n);break;case"source":r.sources.push(y.parse(e,t));break;case"sampler":r.samplers.push(k.parse(e,t));break;case"channel":r.channels.push(w.parse(e,r,t));break;default:t.reportUnexpectedChild(e)}})),r}}class C extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new C;return v(e,(function(e){switch(e.nodeName){case"animation":r.children.push(A.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class S extends f{constructor(){super(),this.unit=0,this.upAxis="",this._className+="Asset|"}static parse(e,t){var r=new S;return v(e,(function(e){switch(e.nodeName){case"unit":r.unit=t.getAttributeAsFloat(e,"meter",1,!1);break;case"up_axis":r.upAxis=t.getTextContent(e).toUpperCase().charAt(0);break;case"contributor":case"created":case"modified":case"revision":case"title":case"subject":case"keywords":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class T extends f{constructor(){super(),this.value=0,this._className+="CameraParam|"}static parse(e,t){var r=new T;return r.sid=t.getAttributeAsString(e,"sid",void 0,!1),r.name=e.nodeName,r.value=parseFloat(t.getTextContent(e)),r}}class _ extends f{constructor(){super(),this.type="",this._className+="Camera|",this.params={}}static parse(e,t){var r=new _;return r.id=t.getAttributeAsString(e,"id",void 0,!0),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!1),v(e,(function(e){switch(e.nodeName){case"asset":case"imager":case"extra":t.reportUnhandledChild(e);break;case"optics":_.parseOptics(e,r,t);break;default:t.reportUnexpectedChild(e)}})),r}static parseOptics(e,t,r){v(e,(function(e){switch(e.nodeName){case"technique_common":_.parseTechniqueCommon(e,t,r);break;case"technique":case"extra":r.reportUnhandledChild(e);break;default:r.reportUnexpectedChild(e)}}))}static parseTechniqueCommon(e,t,r){v(e,(function(e){switch(e.nodeName){case"orthographic":case"perspective":_.parseParams(e,t,r);break;default:r.reportUnexpectedChild(e)}}))}static parseParams(e,t,r){t.type=e.nodeName,v(e,(function(e){switch(e.nodeName){case"xmag":case"ymag":case"xfov":case"yfov":case"aspect_ratio":case"znear":case"zfar":var n=T.parse(e,r);r.registerSidTarget(n,t),t.params[n.name]=n;break;case"extra":r.reportUnhandledChild(e);break;default:r.reportUnexpectedChild(e)}}))}}class N extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new N;return v(e,(function(e){switch(e.nodeName){case"camera":r.children.push(_.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class M extends f{constructor(){super(),this._className+="Morph|"}static parse(e,t){var r=new M;return t.log.write("Morph controllers not implemented",i.Error),r}}class U extends f{constructor(){super(),this._className+="Joints|"}static parse(e,t){var r=new U,n=[];return v(e,(function(e){if("input"===e.nodeName){var a=x.parse(e,!1,t);U.addInput(r,a,t),n.push(a)}else t.reportUnexpectedChild(e)})),r}static addInput(e,t,r){switch(t.semantic){case"JOINT":e.joints=t;break;case"INV_BIND_MATRIX":e.invBindMatrices=t;break;default:r.log?.write("Unknown joints input semantic "+t.semantic,i.Error)}}}class F extends f{constructor(){super(),this.vcount=new Int32Array,this.v=new Int32Array,this.joints=void 0,this.weights=void 0,this.count=0,this._className+="VertexWeights|",this.inputs=[]}static parse(e,t){var r=new F;return r.count=t.getAttributeAsInt(e,"count",0,!0),v(e,(function(e){switch(e.nodeName){case"input":var n=x.parse(e,!0,t);F.addInput(r,n,t);break;case"vcount":r.vcount=t.getIntsContent(e);break;case"v":r.v=t.getIntsContent(e);break;default:t.reportUnexpectedChild(e)}})),r}static addInput(e,t,r){switch(t.semantic){case"JOINT":e.joints=t;break;case"WEIGHT":e.weights=t;break;default:r.log.write("Unknown vertex weights input semantic "+t.semantic,i.Error)}}}class E extends f{constructor(){super(),this.bindShapeMatrix=new Float32Array,this._className+="Skin|"}static parse(e,t){var r=new E;return r.source=t.getAttributeAsUrlLink(e,"source",!0),v(e,(function(e){switch(e.nodeName){case"bind_shape_matrix":r.bindShapeMatrix=t.getFloatsContent(e);break;case"source":r.sources?.push(y.parse(e,t));break;case"joints":r.joints=U.parse(e,t);break;case"vertex_weights":r.vertexWeights=F.parse(e,t);break;default:t.reportUnexpectedChild(e)}})),r}}class L extends f{constructor(){super(),this._className+="Controller|"}static fromLink(e,t){return f._fromLink(e,"Controller",t)}static parse(e,t){var r=new L;return r.id=t.getAttributeAsString(e,"id",void 0,!0),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!0),v(e,(function(e){switch(e.nodeName){case"skin":null!=r.skin&&t.log.write("Controller "+r.id+" has multiple skins",i.Error),r.skin=E.parse(e,t);break;case"morph":null!=r.morph&&t.log.write("Controller "+r.id+" has multiple morphs",i.Error),r.morph=M.parse(e,t);break;default:t.reportUnexpectedChild(e)}})),r}}class I extends f{static parse(e,t){var r=new I;return v(e,(function(e){switch(e.nodeName){case"controller":r.children.push(L.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class W extends f{constructor(){super(),this.wrapS="",this.wrapT="",this.minFilter="",this.magFilter="",this.mipmapMaxLevel=0,this.mipmapBias=0,this._className+="EffectSampler|"}static fromLink(e,t){return f._fromLink(e,"EffectSampler",t)}static parse(e,t,r){var n=new W;return v(e,(function(e){switch(e.nodeName){case"source":n.surface=r.createFxLink(r.getTextContent(e),t);break;case"instance_image":n.image=r.getAttributeAsUrlLink(e,"url",!0);break;case"wrap_s":n.wrapS=r.getTextContent(e);break;case"wrap_t":n.wrapT=r.getTextContent(e);break;case"minfilter":n.minFilter=r.getTextContent(e);break;case"magfilter":n.magFilter=r.getTextContent(e);break;case"border_color":n.borderColor=r.getFloatsContent(e);break;case"mipmap_maxlevel":n.mipmapMaxLevel=r.getIntContent(e);break;case"mipmap_bias":n.mipmapBias=r.getFloatContent(e);break;default:r.reportUnexpectedChild(e)}})),n}}class B extends f{constructor(){super(),this.type="",this.format="",this.size=new Float32Array,this.viewportRatio=new Float32Array,this.mipLevels=0,this.mipmapGenerate=!1,this._className+="EffectSurface|"}static fromLink(e,t){return f._fromLink(e,"EffectSurface",t)}static parse(e,t,r){var n=new B;return n.type=r.getAttributeAsString(e,"type",void 0,!0),v(e,(function(e){switch(e.nodeName){case"init_from":n.initFrom=r.createUrlLink(r.getTextContent(e));break;case"format":n.format=r.getTextContent(e);break;case"size":n.size=r.getFloatsContent(e);break;case"viewport_ratio":n.viewportRatio=r.getFloatsContent(e);break;case"mip_levels":n.mipLevels=r.getIntContent(e);break;case"mipmap_generate":n.mipmapGenerate="true"===r.getTextContent(e).toLowerCase();break;default:r.reportUnexpectedChild(e)}})),n}}class O extends f{constructor(){super(),this._className+="EffectParam|"}static fromLink(e,t){return f._fromLink(e,"EffectParam",t)}static parse(e,t,r){var n=new O;return n.sid=r.getAttributeAsString(e,"sid",void 0,!1),r.registerFxTarget(n,t),v(e,(function(e){switch(e.nodeName){case"semantic":n.semantic=r.getTextContent(e);break;case"float":case"float2":case"float3":case"float4":n.floats=r.getFloatsContent(e);break;case"surface":n.surface=B.parse(e,n,r);break;case"sampler2D":n.sampler=W.parse(e,n,r);break;default:r.reportUnexpectedChild(e)}})),n}}class D extends f{constructor(){super(),this.texcoord="",this.opaque="",this.bumptype="",this._className+="ColorOrTexture|"}static parse(e,t,r){var n=new D;return n.opaque=r.getAttributeAsString(e,"opaque",void 0,!1),n.bumptype=r.getAttributeAsString(e,"bumptype",void 0,!1),v(e,(function(e){switch(e.nodeName){case"color":n.color=r.strToColor(r.getTextContent(e));break;case"texture":n.textureSampler=r.getAttributeAsFxLink(e,"texture",t,!0),n.texcoord=r.getAttributeAsString(e,"texcoord",void 0,!0);break;default:r.reportUnexpectedChild(e)}})),n}}class P extends f{constructor(){super(),this.shading="",this.shininess=0,this.transparency=0,this.reflectivity=0,this.index_of_refraction=0,this.double_sided=!1,this._className+="EffectTechnique|",this.params=[]}static fromLink(e,t){return f._fromLink(e,"EffectTechnique",t)}static parse(e,t,r){var n=new P;return n.sid=r.getAttributeAsString(e,"sid",void 0,!1),r.registerFxTarget(n,t),v(e,(function(e){switch(e.nodeName){case"blinn":case"phong":case"lambert":case"constant":n.shading=e.nodeName,P.parseParam(e,n,"COMMON",r);break;case"extra":P.parseExtra(e,n,r);break;default:r.reportUnexpectedChild(e)}})),n}static parseParam(e,t,r,n){v(e,(function(e){switch(e.nodeName){case"newparam":t.params?.push(O.parse(e,t,n));break;case"emission":t.emission=D.parse(e,t,n);break;case"ambient":t.ambient=D.parse(e,t,n);break;case"diffuse":t.diffuse=D.parse(e,t,n);break;case"specular":t.specular=D.parse(e,t,n);break;case"reflective":t.reflective=D.parse(e,t,n);break;case"transparent":t.transparent=D.parse(e,t,n);break;case"bump":t.bump=D.parse(e,t,n);break;case"shininess":t.shininess=n.getFloatContent(e.childNodes[1]||e.childNodes.item(0));break;case"reflectivity":t.reflectivity=n.getFloatContent(e.childNodes[1]||e.childNodes.item(0));break;case"transparency":t.transparency=n.getFloatContent(e.childNodes[1]||e.childNodes.item(0));break;case"index_of_refraction":t.index_of_refraction=n.getFloatContent(e.childNodes[1]||e.childNodes.item(0));break;case"double_sided":t.double_sided=n.getFloatContent(e)>0;break;default:"COMMON"===r&&n.reportUnexpectedChild(e)}}))}static parseExtra(e,t,r){null!=t?v(e,(function(e){if("technique"===e.nodeName){var n=r.getAttributeAsString(e,"profile",void 0,!0);P.parseParam(e,t,n,r)}else r.reportUnexpectedChild(e)})):r.log.write("Ignored element <extra>, because there is no <technique>.",i.Warning)}}class R extends f{constructor(){super(),this._className+="Effect|",this.params=[]}static fromLink(e,t){return f._fromLink(e,"Effect",t)}static parse(e,t){var r=new R;return r.id=t.getAttributeAsString(e,"id",void 0,!0),t.registerUrlTarget(r,!0),v(e,(function(e){switch(e.nodeName){case"profile_COMMON":R.parseProfileCommon(e,r,t);break;case"profile":t.log.write("Skipped non-common effect profile for effect "+r.id+".",i.Warning);break;case"extra":r.technique&&P.parseExtra(e,r.technique,t);break;default:t.reportUnexpectedChild(e)}})),r}static parseProfileCommon(e,t,r){v(e,(function(e){switch(e.nodeName){case"newparam":t.params.push(O.parse(e,t,r));break;case"technique":t.technique=P.parse(e,t,r);break;case"extra":t.technique&&P.parseExtra(e,t.technique,r);break;default:r.reportUnexpectedChild(e)}}))}}class G extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new G;return v(e,(function(e){switch(e.nodeName){case"effect":r.children.push(R.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class V extends f{constructor(){super(),this.type="",this.count=0,this.material="",this.inputs=[],this.indices=new Uint32Array,this.vcount=new Uint32Array,this._className+="Triangles|"}static parse(e,t){var r=new V;return r.name=t.getAttributeAsString(e,"name",void 0,!1),r.material=t.getAttributeAsString(e,"material",void 0,!1),r.count=t.getAttributeAsInt(e,"count",0,!0)||0,r.type=e.nodeName,v(e,(function(e){switch(e.nodeName){case"input":r.inputs.push(x.parse(e,!0,t));break;case"vcount":r.vcount=t.getUintsContent(e);break;case"p":r.indices=t.getUintsContent(e);break;default:t.reportUnexpectedChild(e)}})),r}}class q extends f{constructor(){super(),this._className+="Vertices|",this.inputs=[]}static fromLink(e,t){return f._fromLink(e,"Vertices",t)}static parse(e,t){var r=new q;return r.id=t.getAttributeAsString(e,"id","",!0),r.name=t.getAttributeAsString(e,"name","",!1),t.registerUrlTarget(r,!0),v(e,(function(e){"input"===e.nodeName?r.inputs.push(x.parse(e,!1,t)):t.reportUnexpectedChild(e)})),r}}class j extends f{constructor(){super(),this._className+="Geometry|",this.sources=[],this.vertices=[],this.triangles=[]}static fromLink(e,t){return f._fromLink(e,"Geometry",t)}static parse(e,t){var r=new j;return r.id=t.getAttributeAsString(e,"id",void 0,!0),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!0),v(e,(function(e){switch(e.nodeName){case"mesh":j.parseMesh(e,r,t);break;case"convex_mesh":case"spline":t.log.write("Geometry type "+e.nodeName+" not supported.",i.Error);break;case"extra":j.parseGeometryExtra(e,r,t);break;default:t.reportUnexpectedChild(e)}})),r}static parseMesh(e,t,r){v(e,(function(e){switch(e.nodeName){case"source":t.sources.push(y.parse(e,r));break;case"vertices":t.vertices.push(q.parse(e,r));break;case"triangles":case"polylist":case"polygons":t.triangles.push(V.parse(e,r));break;case"lines":case"linestrips":case"trifans":case"tristrips":r.log.write("Geometry primitive type "+e.nodeName+" not supported.",i.Error);break;default:r.reportUnexpectedChild(e)}}))}static parseGeometryExtra(e,t,r){v(e,(function(e){if("technique"===e.nodeName){var n=r.getAttributeAsString(e,"profile",void 0,!0);j.parseGeometryExtraTechnique(e,t,n,r)}else r.reportUnexpectedChild(e)}))}static parseGeometryExtraTechnique(e,t,r,n){v(e,(function(e){e.nodeName,n.reportUnhandledChild(e)}))}}class z extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new z;return v(e,(function(e){switch(e.nodeName){case"geometry":r.children.push(j.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class J extends f{constructor(){super(),this._className+="Image|"}static fromLink(e,t){return f._fromLink(e,"Image",t)}static parse(e,t){var r=new J;return r.id=t.getAttributeAsString(e,"id",void 0,!0),t.registerUrlTarget(r,!0),v(e,(function(e){"init_from"===e.nodeName?r.initFrom=t.getTextContent(e):t.reportUnexpectedChild(e)})),r}}class X extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new X;return v(e,(function(e){switch(e.nodeName){case"image":r.children.push(J.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class H extends f{constructor(){super(),this._className+="LightParam|"}static parse(e,t){var r=new H;return r.sid=t.getAttributeAsString(e,"sid",void 0,!1),r.name=e.nodeName,r.value=t.getFloatContent(e),r}}class Q extends f{constructor(){super(),this._className+="Light|",this.params={}}static parse(e,t){var r=new Q;return r.id=t.getAttributeAsString(e,"id",void 0,!0),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!1),v(e,(function(e){switch(e.nodeName){case"technique_common":Q.parseTechniqueCommon(e,r,t);break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}static parseTechniqueCommon(e,t,r){v(e,(function(e){switch(e.nodeName){case"ambient":case"directional":case"point":case"spot":Q.parseParams(e,t,"COMMON",r);break;default:r.reportUnexpectedChild(e)}}))}static parseParams(e,t,r,n){t.type=e.nodeName,v(e,(function(e){switch(e.nodeName){case"color":t.color=n.getFloatsContent(e);break;case"constant_attenuation":case"linear_attenuation":case"quadratic_attenuation":case"falloff_angle":case"falloff_exponent":var r=H.parse(e,n);n.registerSidTarget(r,t),t.params[r.name]=r;break;default:n.reportUnexpectedChild(e)}}))}}class K extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new K;return v(e,(function(e){switch(e.nodeName){case"effect":r.children.push(Q.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class Y extends f{constructor(){super(),this._className+="Material|"}static fromLink(e,t){return f._fromLink(e,"Material",t)}static parse(e,t){var r=new Y;return r.id=t.getAttributeAsString(e,"id",void 0,!0),r.name=t.getAttributeAsString(e,"name",void 0,!1),t.registerUrlTarget(r,!0),v(e,(function(e){"instance_effect"===e.nodeName?r.effect=t.getAttributeAsUrlLink(e,"url",!0):t.reportUnexpectedChild(e)})),r}}class Z extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new Z;return v(e,(function(e){switch(e.nodeName){case"material":r.children.push(Y.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class $ extends f{constructor(){super(),this._className+="InstanceCamera|"}static parse(e,t,r){var n=new $;return n.camera=r.getAttributeAsUrlLink(e,"url",!0),n.sid=r.getAttributeAsString(e,"sid",void 0,!1),n.name=r.getAttributeAsString(e,"name",void 0,!1),r.registerSidTarget(n,t),v(e,(function(e){"extra"===e.nodeName?r.reportUnhandledChild(e):r.reportUnexpectedChild(e)})),n}}class ee extends f{constructor(){super(),this.symbol="",this._className+="InstanceMaterial|",this.params={},this.vertexInputs={}}static parse(e,t,r){var n=new ee;return n.symbol=r.getAttributeAsString(e,"symbol",void 0,!1),n.material=r.getAttributeAsUrlLink(e,"target",!0),r.registerSidTarget(n,t),v(e,(function(e){switch(e.nodeName){case"bind_vertex_input":ee.parseBindVertexInput(e,n,r);break;case"bind":ee.parseBind(e,n,r);break;default:r.reportUnexpectedChild(e)}})),n}static parseBindVertexInput(e,t,r){var n=r.getAttributeAsString(e,"semantic",void 0,!0),a=r.getAttributeAsString(e,"input_semantic",void 0,!0),s=r.getAttributeAsInt(e,"input_set",0,!1);null!=n&&null!=a&&s?t.vertexInputs[n]={inputSemantic:a,inputSet:s}:r.log.write("Skipped a material vertex binding because of missing semantics.",i.Warning)}static parseBind(e,t,r){var n=r.getAttributeAsString(e,"semantic",void 0,!1),a=r.getAttributeAsSidLink(e,"target","",!0);null!=n&&a?t.params[n]={target:a}:r.log.write("Skipped a material uniform binding because of missing semantics.",i.Warning)}}class te{static parse(e,t,r){v(e,(function(e){"technique_common"===e.nodeName?te.parseTechniqueCommon(e,t,r):r.reportUnexpectedChild(e)}))}static parseTechniqueCommon(e,t,r){v(e,(function(e){"instance_material"===e.nodeName?t.materials.push(ee.parse(e,t,r)):r.reportUnexpectedChild(e)}))}}class re extends f{constructor(){super(),this._className+="InstanceController|",this.skeletons=[],this.materials=[]}static parse(e,t,r){var n=new re;return n.controller=r.getAttributeAsUrlLink(e,"url",!0),n.sid=r.getAttributeAsString(e,"sid",void 0,!1),n.name=r.getAttributeAsString(e,"name",void 0,!1),r.registerSidTarget(n,t),v(e,(function(e){switch(e.nodeName){case"skeleton":n.skeletons.push(r.createUrlLink(r.getTextContent(e)));break;case"bind_material":te.parse(e,n,r);break;default:r.reportUnexpectedChild(e)}})),n}}class ne extends f{constructor(){super(),this._className+="InstanceGeometry|",this.materials=[]}static parse(e,t,r){var n=new ne;return n.geometry=r.getAttributeAsUrlLink(e,"url",!0),n.sid=r.getAttributeAsString(e,"sid",void 0,!1),v(e,(function(e){"bind_material"===e.nodeName?te.parse(e,n,r):r.reportUnexpectedChild(e)})),n}}class ae extends f{constructor(){super(),this._className+="InstanceLight|"}static parse(e,t,r){var n=new ae;return n.light=r.getAttributeAsUrlLink(e,"url",!0),n.sid=r.getAttributeAsString(e,"sid",void 0,!1),n.name=r.getAttributeAsString(e,"name",void 0,!1),r.registerSidTarget(n,t),v(e,(function(e){"extra"===e.nodeName?r.reportUnhandledChild(e):r.reportUnexpectedChild(e)})),n}}class ie extends f{constructor(){super(),this._className+="NodeTransform|"}static parse(e,t,r){var n=new ie;n.sid=r.getAttributeAsString(e,"sid",void 0,!1),n.type=e.nodeName,r.registerSidTarget(n,t),n.data=r.getFloatsContent(e);var a=0;switch(n.type){case"matrix":a=16;break;case"rotate":a=4;break;case"translate":case"scale":a=3;break;case"skew":a=7;break;case"lookat":a=9;break;default:r.log.write("Unknown transformation type "+n.type+".",i.Error)}return n.data.length!==a&&r.log.write("Wrong number of elements for transformation type '"+n.type+"': expected "+a+", found "+n.data.length,i.Error),n}}class se extends f{constructor(){super(),this._className+="VisualSceneNode|",this.type="",this.layer="",this.children=[],this.parent=void 0,this.transformations=[],this.geometries=[],this.controllers=[],this.lights=[],this.cameras=[]}static fromLink(e,t){return f._fromLink(e,"VisualSceneNode",t)}static registerParent(e,t,r){e.parent=t,r.registerSidTarget(e,t)}static parse(e,t){var r=new se;return r.id=t.getAttributeAsString(e,"id",void 0,!1),r.sid=t.getAttributeAsString(e,"sid",void 0,!1),r.name=t.getAttributeAsString(e,"name",void 0,!1),r.type=t.getAttributeAsString(e,"type",void 0,!1),r.layer=t.getAttributeAsString(e,"layer",void 0,!1),t.registerUrlTarget(r,!1),v(e,(function(e){switch(e.nodeName){case"instance_geometry":r.geometries.push(ne.parse(e,r,t));break;case"instance_controller":r.controllers.push(re.parse(e,r,t));break;case"instance_light":r.lights.push(ae.parse(e,r,t));break;case"instance_camera":r.cameras.push($.parse(e,r,t));break;case"matrix":case"rotate":case"translate":case"scale":r.transformations.push(ie.parse(e,r,t));break;case"node":var n=se.parse(e,t);se.registerParent(n,r,t),r.children.push(n);break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class oe extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new oe;return v(e,(function(e){switch(e.nodeName){case"node":r.children.push(se.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class le extends f{constructor(){super(),this._className+="VisualScene|",this.children=[]}static fromLink(e,t){return f._fromLink(e,"VisualScene",t)}static parse(e,t){var r=new le;return r.id=t.getAttributeAsString(e,"id","",!1),t.registerUrlTarget(r,!1),v(e,(function(e){if("node"===e.nodeName){var n=se.parse(e,t);se.registerParent(n,r,t),r.children.push(n)}else t.reportUnexpectedChild(e)})),r}}class ce extends f{constructor(){super(...arguments),this.children=[]}static parse(e,t){var r=new ce;return v(e,(function(e){switch(e.nodeName){case"visual_scene":r.children.push(le.parse(e,t));break;case"extra":t.reportUnhandledChild(e);break;default:t.reportUnexpectedChild(e)}})),r}}class ue{constructor(){this.libEffects=new G,this.libMaterials=new Z,this.libGeometries=new z,this.libControllers=new I,this.libLights=new K,this.libCameras=new N,this.libImages=new X,this.libVisualScenes=new ce,this.libAnimations=new C,this.libNodes=new oe}static parse(e,t){var r=e.getElementsByTagName("COLLADA");return 0===r.length?(t.log?.write("Cannot parse document, no top level COLLADA element.",i.Error),new ue):r.length>1?(t.log?.write("Cannot parse document, more than one top level COLLADA element.",i.Error),new ue):ue.parseCOLLADA(r[0]||r.item(0),t)}static parseCOLLADA(e,t){var r=new ue;return v(e,(function(e){switch(e.nodeName){case"asset":r.asset=S.parse(e,t);break;case"scene":r.scene=b.parse(e,t);break;case"library_effects":r.libEffects=G.parse(e,t);break;case"library_materials":r.libMaterials=Z.parse(e,t);break;case"library_geometries":r.libGeometries=z.parse(e,t);break;case"library_images":r.libImages=X.parse(e,t);break;case"library_visual_scenes":r.libVisualScenes=ce.parse(e,t);break;case"library_controllers":r.libControllers=I.parse(e,t);break;case"library_animations":r.libAnimations=C.parse(e,t);break;case"library_lights":r.libLights=K.parse(e,t);break;case"library_cameras":r.libCameras=N.parse(e,t);break;case"library_nodes":r.libNodes=oe.parse(e,t);break;default:t.reportUnexpectedChild(e)}})),r}}class de{constructor(){this.log=new c}_reportError(e,t){this.onFinished&&this.onFinished(e,void 0)}_reportSuccess(e,t,r){this.onFinished&&this.onFinished(e,t)}_reportProgress(e,t){this.onProgress&&this.onProgress(e,t.loadedBytes,t.totalBytes)}loadFromXML(e,t){var r=new g(this.log);return this._loadFromXML(e,t,r)}_loadFromXML(e,t,r){var n=void 0;try{n=ue.parse(t,r),r.resolveAllLinks()}catch(t){return r.log.write(t.message+"\n"+t.stack,i.Exception),r.log.write(t.message+"\n"+t.stack,i.Error),void this._reportError(e,r)}return this._reportSuccess(e,n,r),n}loadFromURL(e,t){var r=new g(this.log),n=this;if(null!=document&&null!=document.implementation&&null!=document.implementation.createDocument){var a=new XMLHttpRequest;"function"==typeof a.overrideMimeType&&a.overrideMimeType("text/xml"),a.onreadystatechange=function(){if(4===a.readyState){if(0===a.status||200===a.status)if(a.responseXML){var s=ue.parse(a.responseXML,r);n._reportSuccess(e,s,r)}else r.log.write("Empty or non-existing file "+t+".",i.Error),n._reportError(e,r)}else 3===a.readyState&&(r.totalBytes>0||(r.totalBytes=parseInt(a.getResponseHeader("Content-Length")||"0")),r.loadedBytes=a.responseText.length,n._reportProgress(e,r))},a.open("GET",t,!0),a.send(null)}else r.log.write("Don't know how to parse XML!",i.Error),n._reportError(e,r)}}class he{constructor(){this.chunks=[],this.skeleton=new ge,this.materials=[],this.animations=[]}}class me{constructor(){this.name="",this.triangle_count=0,this.vertex_count=0,this.index_offset=0,this.material_index=0}}class pe{constructor(){this.diffuse="",this.specular="",this.normal=""}hash(){return"material|"+(this.diffuse||"")+"|"+(this.specular||"")+"|"+(this.normal||"")+"|"+(this.diffuseColor||"")+"|"+(this.specularColor||"|"+(this.emissiveColor||""))}}class ge{constructor(){this.bones=[]}}class fe{constructor(){this.name="",this.parent=0,this.skinned=!1,this.pos=new s.Vector3,this.rot=new s.Quaternion,this.scl=new s.Vector3}}class ve{constructor(){this.name="",this.frames=0,this.fps=0,this.tracks=[]}}class be{constructor(){this.bone=0}}class we{constructor(){}loadFloatData(e,t){return e?new Float32Array(t,e.byte_offset,e.count*e.stride):null}loadUint8Data(e,t){return e?new Uint8Array(t,e.byte_offset,e.count*e.stride):null}loadUint32Data(e,t){return e?new Uint32Array(t,e.byte_offset,e.count*e.stride):null}loadModelChunk(e,t){var r=new me;return r.name=e.name,r.triangle_count=e.triangle_count,r.material_index=e.material,r.data_position=this.loadFloatData(e.position,t),r.data_normal=this.loadFloatData(e.normal,t),r.data_texcoord=this.loadFloatData(e.texcoord,t),r.data_boneweight=this.loadFloatData(e.boneweight,t),r.data_boneindex=this.loadUint8Data(e.boneindex,t),r.data_indices=this.loadUint32Data(e.indices,t),r.data_boneindex&&(r.data_boneindex=new Uint8Array(r.data_boneindex)),r}loadModel(e,t){var r=new he;return r.chunks=e.chunks.map((e=>this.loadModelChunk(e,t))),r.skeleton=this.loadSkeleton(e,t),r.animations=e.animations.map((e=>this.loadAnimation(e,t))),r.materials=e.materials.map((e=>this.loadMaterial(e,t))),r}loadBone(e,t){if(null==e)return null;var r=new fe;return r.name=e.name,r.parent=e.parent,r.skinned=e.skinned,r.inv_bind_mat=new Float32Array(e.inv_bind_mat),r.matrix=new Float32Array(e.matrix),r.pos.set(e.pos[0],e.pos[1],e.pos[2]),r.rot.set(e.rot[0],e.rot[1],e.rot[2],e.rot[3]),r.scl.set(e.scl[0],e.scl[1],e.scl[2]),r}loadSkeleton(e,t){if(null==e.bones||0==e.bones.length)return null;var r=new ge;return r.bones=e.bones.map((e=>this.loadBone(e,t))),r}loadAnimationTrack(e,t){if(null==e)return null;var r=new be;return r.bone=e.bone,r.pos=this.loadFloatData(e.pos,t),r.rot=this.loadFloatData(e.rot,t),r.scl=this.loadFloatData(e.scl,t),r}loadAnimation(e,t){if(null==e)return null;var r=new ve;return r.name=e.name,r.fps=e.fps,r.frames=e.frames,r.tracks=e.tracks.map((e=>this.loadAnimationTrack(e,t))),r}loadMaterial(e,t){var r=new pe;return r.diffuse=e.diffuse,r.specular=e.specular,r.normal=e.normal,r.diffuseColor=e.diffuseColor,r.specularColor=e.specularColor,r.emissiveColor=e.emissiveColor,r}}class xe{constructor(){this.materialCache={}}createGeometry(e,t){var r=new s.VertexData;if(e.data_position&&(r.positions=e.data_position),e.data_normal&&(r.normals=e.data_normal),e.data_texcoord&&(r.uvs=e.data_texcoord),e.data_boneindex,e.data_boneindex,e.data_indices){r.indices=e.data_indices;for(var n=0;n<r.indices.length;n+=3){var a=r.indices[n];r.indices[n]=r.indices[n+2],r.indices[n+2]=a}}return r}createTexture(e,t){return null==e||""==e?new s.Texture("",t):new s.Texture(e,t)}parseColor(e){var t=(e=e.trim()).split(" ");if(t.length>=3)throw new Error("Color ${rgba} does not have 3 values");return new s.Color3(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))}createMaterial(e,t,r){var n=(t?"skinned-":"static-")+e.hash(),a=this.materialCache[n];if(a)return a;var i=new s.StandardMaterial(n,r);return i.backFaceCulling=!1,e.diffuse&&(i.diffuseTexture=this.createTexture(e.diffuse,r)),e.specular&&(i.specularTexture=this.createTexture(e.specular,r)),null!=e.diffuseColor&&4==e.diffuseColor.length&&(i.diffuseColor=new s.Color3(e.diffuseColor[0],e.diffuseColor[1],e.diffuseColor[2])),null!=e.emissiveColor&&4==e.emissiveColor.length&&(i.emissiveColor=new s.Color3(e.emissiveColor[0],e.emissiveColor[1],e.emissiveColor[2])),null!=e.specularColor&&4==e.specularColor.length?i.specularColor=new s.Color3(e.specularColor[0],e.specularColor[1],e.specularColor[2]):i.specularColor=new s.Color3(.5,.5,.5),this.materialCache[n]=i,i}createBabylonModel(e,t){var r=new ye,n=!!e.skeleton;let a=[];if(e.skeleton){for(var i=0;i<e.skeleton.bones.length;++i){var o=e.skeleton.bones[i];let r=s.Matrix.FromArray(o.matrix),n=new s.TransformNode(o.name,t);n.setPreTransformMatrix(r),a.push(n)}for(i=0;i<e.skeleton.bones.length;++i)(o=e.skeleton.bones[i]).parent>=0&&o.parent<a.length&&(a[i].parent=a[o.parent])}for(r.transformNodes=a,i=0;i<e.chunks.length;++i){var l=e.chunks[i],c=new ke;if(c.geometry=this.createGeometry(l,t),c.material=this.createMaterial(e.materials[l.material_index],n,t),r.chunks.push(c),c.geometry){var u=new s.Mesh(l.name,t);c.geometry.applyToMesh(u),u.material=c.material,r.meshes.push(u);var d=u.getVerticesData(s.VertexBuffer.NormalKind),h=u.getVerticesData(s.VertexBuffer.PositionKind);if(s.VertexData.ComputeNormals(h,u.getIndices(),d,{useRightHandedSystem:t.useRightHandedSystem}),u.updateVerticesData(s.VertexBuffer.NormalKind,d),u.convertToFlatShadedMesh(),u.sideOrientation=s.Material.CounterClockWiseSideOrientation,r.transformNodes){var m=l.data_boneindex;if(m)for(var p=m.length/4,g=0;g<p;++g){var f=m[4*g];f>=0&&f<r.transformNodes.length&&(u.parent=r.transformNodes[f])}}}}return r.animations=e.animations,r}}class ke{constructor(){this.geometry=void 0,this.material=void 0}}class ye{constructor(){this.meshes=[],this.chunks=[],this.transformNodes=void 0,this.animations=[]}}function Ae(e,t,r,n,a,i,s,o,l,c){for(var u=Math.min(a,c),d=t.length,h=n,m=l;h<d;){var p=t[h];h+=r;var g=s[m];m+=o;for(var f=0;f<u;++f)i[a*g+f]=e[c*p+f]}}function Ce(e,t,r,n){if(!e)return null;if(e.stride>r?n.log.write("Source data for "+t+" contains too many dimensions, "+(e.stride-r)+" dimensions will be ignored",i.Warning):e.stride<r&&n.log.write("Source data for "+t+" does not contain enough dimensions, "+(r-e.stride)+" dimensions will be zero",i.Warning),e.offset,e.offset+e.count*e.stride>e.data.length)return n.log.write("Source for "+t+" tries to access too many elements, data ignored",i.Warning),null;if(!(e.data instanceof Float32Array))return n.log.write("Source for "+t+" does not contain floating point data, data ignored",i.Warning),null;for(var a=e.data,s=new Float32Array(e.count*r),o=e.offset,l=e.stride,c=r,u=0;u<e.count;++u)for(var d=0;d<r;++d)s[0+c*u+d]=a[o+l*u+d];return s}function Se(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function Te(e,t,r,n,a,i){if(t[i]<n){t[i]=n,e[i]=r;for(var s=i;s>a;--s)t[s]>t[s-1]&&(Se(t,s,s-1),Se(e,s,s-1))}}ye.identityMatrix=new s.Matrix;var _e=new s.Matrix;function Ne(e){var t=_e;t.copyFrom(Ee(e));var r=function(e){var t=e.options.worldTransformScale.value;return new s.Vector3(t,t,t)}(e),n=s.Matrix.Scaling(r.x,r.y,r.z);return t.multiply(n)}var Me=new s.Matrix;new s.Vector3,new s.Vector3;var Ue,Fe=new s.Matrix;function Ee(e){var t=e.options.worldTransformRotationAxis.value,r=e.options.worldTransformRotationAngle.value*Math.PI/180,n=Fe;switch(t){case"none":break;case"x":n=s.Matrix.RotationX(r);break;case"y":n=s.Matrix.RotationY(r);break;case"z":n=s.Matrix.RotationZ(r);break;default:e.log.write("Unknown rotation axis",i.Warning)}return n}function Le(e,t,r,n,a){for(var i=0;i<a;++i)r[n+i]=e[t+i]}function Ie(e,t,r){let n=new Float32Array(16);for(var a=0;a<16;++a)n[a]=e[16*t+a];r.copyFrom(s.Matrix.FromArray(n).transpose())}function We(e,t,r,n,a){if(a<0||a>1)throw new Error("Invalid Bezier parameter: "+a);return e*(1-a)*(1-a)*(1-a)+3*t*a*(1-a)*(1-a)+3*r*a*a*(1-a)+n*a*a*a}function Be(e,t,r,n,a){if(a<0||a>1)throw new Error("Invalid Hermite parameter: "+a);var i=a*a,s=i*a;return e*(2*s-3*i+1)+t*(s-2*i+a)+n*(-2*s+3*i)+r*(s-i)}function Oe(e,t,r,n){var a=0,i=1,s=t(a),o=t(i);if(e<=s)return a;if(e>=o)return i;for(var l=.5*(a+i),c=t(l),u=0;Math.abs(c-e)>r;){if(c<e)a=l;else{if(!(c>e))return l;i=l}if(c=t(l=.5*(a+i)),++u>n)throw new Error("Too many iterations")}return l}Math.PI;class De{constructor(){this.target=null,this.interpolation=null,this.input=null,this.output=null,this.inTangent=null,this.outTangent=null,this.dataOffset=null,this.dataCount=null}findInputIndices(e,t){var r=this.input,n=e=>{var r=t.messageCount["findInputIndices-invalidTime"]||0;r<10?t.log.write(e,i.Warning):10==r&&t.log.write("Further warnings about invalid time suppressed.",i.Warning),t.messageCount["findInputIndices-invalidTime"]=r+1};if(1===r.length)return e!==r[0]&&n("Resampling input with only one keyframe: t="+e+", t_begin="+r[0]+", using first keyframe"),{i0:0,i1:0};if(e<r[0])return n("Invalid time for resampling: t="+e+", t_begin="+r[0]+", using first keyframe"),{i0:0,i1:1};if(e>r[r.length-1])return n("Invalid time for resampling: t="+e+", t_end="+r[r.length-1]+", using last keyframe"),{i0:r.length-2,i1:r.length-1};for(var a=0;a<r.length-1;++a){var s=r[a],o=r[a+1];if(s<=e&&e<=o)return{i0:a,i1:a+1}}return t.log.write("Keyframes for time "+e+"not found, using first keyframe",i.Warning),{i0:0,i1:1}}static createInputData(e,t,r,n){if(!e)return null;var a=y.fromLink(e.source,n);return a?r!=a.stride?(n.log.write("Animation channel has a nonstandard dimensionality for "+t+", data ignored",i.Warning),null):Ce(a,t,r,n):(n.log.write("Animation channel has no "+t+" input data, data ignored",i.Warning),null)}static createInputDataFromArray(e,t,r,n){return e.length>0?(e.length>1&&n.log.write("Animation channel has more than one "+t+" input, using only the first one",i.Warning),De.createInputData(e[0],t,r,n)):null}static create(e,t){var r=new De,n=f.fromLink(e.target,t);if(!n)return t.log.write("Animation channel has an invalid target '"+e.target.url+"', animation ignored",i.Warning),null;var a=t.animationTargets.findConverter(n);if(!a)return t.log.write("Animation channel has no converter target '"+e.target.url+"', animation ignored",i.Warning),null;r.target=a;var s=k.fromLink(e.source,t);if(!s)return t.log.write("Animation channel has an invalid sampler '"+e.source.url+"', animation ignored",i.Warning),null;var o=a.getTargetDataRows(),l=a.getTargetDataColumns(),c=e.target;if(c.dotSyntax)switch(r.dataCount=1,c.member){case"X":case"R":case"U":case"S":r.dataOffset=0;break;case"Y":case"G":case"V":case"T":r.dataOffset=1;break;case"Z":case"B":case"P":r.dataOffset=2;break;case"W":case"Q":case"ANGLE":r.dataOffset=3;break;default:return t.log.write("Unknown semantic for '"+c.url+"', animation ignored",i.Warning),null}else if(e.target.arrSyntax)switch(r.dataCount=1,c.indices.length){case 1:r.dataOffset=c.indices[0];break;case 2:r.dataOffset=c.indices[0]*o+c.indices[1];break;default:return t.log.write("Invalid number of indices for '"+c.url+"', animation ignored",i.Warning),null}else r.dataOffset=0,r.dataCount=l*o;if(r.input=De.createInputData(s.input,"input",1,t),r.output=De.createInputDataFromArray(s.outputs,"output",r.dataCount,t),r.inTangent=De.createInputDataFromArray(s.inTangents,"intangent",r.dataCount+1,t),r.outTangent=De.createInputDataFromArray(s.outTangents,"outtangent",r.dataCount+1,t),!r.input)return t.log.write("Animation channel has no input data, animation ignored",i.Warning),null;if(!r.output)return t.log.write("Animation channel has no output data, animation ignored",i.Warning),null;var u=s.interpolation;if(!u)return t.log.write("Animation channel has no interpolation input, animation ignored",i.Warning),null;var d=y.fromLink(u.source,t);return d?(r.interpolation=function(e,t,r,n){if(!e)return[];if(e.stride>1?n.log.write("Source data for "+t+" contains too many dimensions, "+(e.stride-1)+" dimensions will be ignored",i.Warning):e.stride<1&&n.log.write("Source data for "+t+" does not contain enough dimensions, "+(1-e.stride)+" dimensions will be zero",i.Warning),e.offset,e.offset+e.count*e.stride>e.data.length)return n.log.write("Source for "+t+" tries to access too many elements, data ignored",i.Warning),[];if(!(e.data instanceof Array))return n.log.write("Source for "+t+" does not contain string data, data ignored",i.Warning),[];for(var a=e.data,s=new Array(1*e.count),o=e.offset,l=e.stride,c=0;c<e.count;++c)for(var u=0;u<1;++u)s[0+1*c+u]=a[o+l*c+u];return s}(d,"interpolation type",0,t),a.registerAnimation(r),r):(t.log.write("Animation channel has no interpolation source, animation ignored",i.Warning),null)}static interpolateLinear(e,t,r,n,a,i,s,o,l){for(var c=(e-t)/(r-t),u=0;u<i;++u){var d=o.output[n*i+u],h=o.output[a*i+u];l[s+u]=d+c*(h-d)}}static interpolateBezier(e,t,r,n,a,i,s,o,l){for(var c=o.outTangent[n*(i+1)],u=o.inTangent[a*(i+1)],d=Oe(e,(e=>We(t,c,u,r,e)),1e-4*Math.abs(r-t),100),h=(Math.abs(e-We(t,c,u,r,d)),0);h<i;++h){var m=o.output[n*i+h],p=o.output[a*i+h],g=o.outTangent[n*(i+1)+h+1],f=o.inTangent[a*(i+1)+h+1];l[s+h]=We(m,g,f,p,d)}}static interpolateHermite(e,t,r,n,a,i,s,o,l){for(var c=o.outTangent[n*(i+1)],u=o.inTangent[a*(i+1)],d=Oe(e,(e=>Be(t,c,u,r,e)),1e-5*Math.abs(r-t),100),h=0;h<i;++h){var m=o.output[n*i+h],p=o.output[a*i+h];t=o.outTangent[n*(i+1)+h+1],r=o.inTangent[a*(i+1)+h+1],l[s+h]=Be(m,t,r,p,d)}}static applyToData(e,t,r,n){if(e.input&&e.output){var a=e.findInputIndices(r,n),s=a.i0,o=a.i1,l=e.input[s],c=e.input[o],u=e.dataCount,d=e.dataOffset,h=e.interpolation[a.i0];switch(s===o&&(h="STEP"),h){case"STEP":for(var m=0;m<u;++m)t[d+m]=e.output[s*u+m];break;case"LINEAR":De.interpolateLinear(r,l,c,s,o,u,d,e,t);break;case"BEZIER":null!==e.inTangent&&null!==e.outTangent?De.interpolateBezier(r,l,c,s,o,u,d,e,t):De.interpolateLinear(r,l,c,s,o,u,d,e,t);break;case"HERMITE":null!==e.inTangent&&null!==e.outTangent?De.interpolateHermite(r,l,c,s,o,u,d,e,t):De.interpolateLinear(r,l,c,s,o,u,d,e,t);break;case"CARDINAL":case"BSPLINE":for(n.log.write("Interpolation type "+h+" not supported, using STEP",i.Warning),m=0;m<u;++m)t[d+m]=e.input[s*u+m];break;default:for(n.log.write("Unknown interpolation type "+h+" at time "+r+", using STEP",i.Warning),m=0;m<u;++m)t[d+m]=e.input[s*u+m]}}}}class Pe{constructor(){this.beginTime=new Re,this.endTime=new Re,this.duration=new Re,this.keyframes=new Re,this.fps=new Re}addDataPoint(e,t,r){var n=t-e;if(this.beginTime.addDataPoint(e),this.endTime.addDataPoint(t),this.duration.addDataPoint(n),this.keyframes.addDataPoint(r),n>0){var a=(r-1)/n;this.fps.addDataPoint(a)}}}class Re{constructor(){this.data=[],this.sorted=!0}addDataPoint(e){this.data.push(e),this.sorted=!1}sort(){this.sorted||(this.sorted=!0,this.data=this.data.sort(((e,t)=>e-t)))}compute(e){return this.data.length>0?(this.sort(),e(this.data)):null}count(){return this.compute((e=>e.length))}min(){return this.compute((e=>e[0]))}max(){return this.compute((e=>e[e.length-1]))}median(){return this.compute((e=>{var t=(this.data.length-1)/2;return(this.data[Math.floor(t)]+this.data[Math.ceil(t)])/2}))}sum(){return this.compute((e=>e.reduce(((e,t)=>e+t),0)))}mean(){return this.compute((e=>this.sum()/this.count()))}}class Ge{constructor(){this.id=null,this.name=null,this.channels=[]}static create(e,t){var r=new Ge;return r.id=e.id,r.name=e.name,Ge.addChannelsToAnimation(e,r,t),r}static addChannelsToAnimation(e,t,r){for(var n=0;n<e.channels.length;++n){var a=De.create(e.channels[n],r);t.channels.push(a)}for(n=0;n<e.children.length;++n){var i=e.children[n];Ge.addChannelsToAnimation(i,t,r)}}static getTimeStatistics(e,t,r,n,a){for(var i=0;i<e.channels.length;++i){var s=e.channels[i];if(s){var o=null!==t?t:-1/0;o=Math.min(Math.max(o,0),s.input.length-1);var l=null!==r?r:1/0;l=Math.min(Math.max(l,0),s.input.length-1);var c=s.input[o],u=s.input[l],d=l-o+1;n.addDataPoint(c,u,d)}}}}class Ve{constructor(){this.pos=new Float32Array,this.rot=new Float32Array,this.scl=new Float32Array,this.rel_pos=new Float32Array,this.rel_rot=new Float32Array,this.rel_scl=new Float32Array}}function qe(e,t,r,n){n.log.write(e+": "+t.mean().toFixed(r)+" (min: "+t.min().toFixed(r)+", med: "+t.median().toFixed(r)+", max: "+t.max().toFixed(r)+")",i.Debug)}class je{constructor(){this.duration=0,this.keyframes=0,this.fps=0,this.original_fps=0,this.name="",this.tracks=[]}static create(e,t,r,n,a,o){var l=new je;l.name=t.name;var c=t.channels,u=new Pe;if(Ge.getTimeStatistics(t,r,n,u,o),qe("Original Duration",u.duration,3,o),qe("Original Time Start",u.beginTime,3,o),qe("Original Time Stop",u.endTime,3,o),qe("Original Keyframes",u.keyframes,3,o),qe("Original FPS",u.fps,3,o),a||(a=u.fps.median()),!a||a<=0)return o.log.write("Could not determine FPS for animation, skipping animation",i.Warning),l;var d=u.beginTime.min(),h=u.endTime.max()-d,m=Math.max(Math.floor(a*h+1e-4)+1,2);o.options.truncateResampledAnimations.value?h=(m-1)/a:a=(m-1)/h;var p=1/a;if(o.log.write("Resampled duration: "+h.toFixed(3),i.Debug),o.log.write("Resampled keyframes: "+m.toFixed(3),i.Debug),o.log.write("Resampled FPS: "+a.toFixed(3),i.Debug),l.fps=+a.toFixed(3),l.keyframes=m,l.duration=h,l.original_fps=u.fps.median(),!(a>0))return o.log.write("Invalid FPS: "+a+", skipping animation",i.Warning),l;if(!(h>0))return o.log.write("Invalid duration: "+h+", skipping animation",i.Warning),l;if(!(m>0))return o.log.write("Invalid number of keyframes: "+m+", skipping animation",i.Warning),l;for(var g=0;g<e.bones.length;++g){var f=e.bones[g];(T=new Ve).pos=new Float32Array(3*m),T.rot=new Float32Array(4*m),T.scl=new Float32Array(3*m),T.rel_pos=new Float32Array(3*m),T.rel_rot=new Float32Array(4*m),T.rel_scl=new Float32Array(3*m),l.tracks.push(T)}var v=l.tracks;for(g=0;g<e.bones.length;++g)(f=e.bones[g]).node.resetAnimation();for(var b=new s.Vector3,w=new s.Quaternion,x=new s.Vector3,k=0;k<m;++k){for(var y=d+k*p,A=0;A<c.length;++A){var C=c[A];C&&C.target.applyAnimation(C,y,o)}for(var S=0;S<e.bones.length;++S){f=e.bones[S];var T=v[S];f.node.getLocalMatrix(o).decompose(x,w,b),null!==T.pos&&(T.pos[3*k+0]=b.x,T.pos[3*k+1]=b.y,T.pos[3*k+2]=b.z),null!==T.rot&&(T.rot[4*k+0]=w.x,T.rot[4*k+1]=w.y,T.rot[4*k+2]=w.z,T.rot[4*k+3]=w.w),null!==T.scl&&(T.scl[3*k+0]=x.x,T.scl[3*k+1]=x.y,T.scl[3*k+2]=x.z)}}for(g=0;g<e.bones.length;++g)(f=e.bones[g]).node.resetAnimation();var _=new s.Vector3,N=new s.Vector3,M=new s.Quaternion,U=new s.Quaternion,F=new s.Vector3,E=new s.Vector3;for(S=0;S<e.bones.length;++S){f=e.bones[S],T=v[S],f.node.getLocalMatrix(o).decompose(F,M,_),U=M.invert(),N=_.negate(),E.set(1/F.x,1/F.y,1/F.z);var L=0,I=0,W=0,B=0,O=0,D=0;for(k=0;k<m;++k)b.x=T.pos[3*k+0],b.y=T.pos[3*k+1],b.z=T.pos[3*k+2],b.addInPlace(N),L=b.length(),B=Math.max(B,L),w.x=T.rot[4*k+0],w.y=T.rot[4*k+1],w.z=T.rot[4*k+2],w.w=T.rot[4*k+3],w.multiply(U),I=2*Math.acos(Math.min(Math.max(w.w,-1),1)),O=Math.max(O,I),x.x=T.scl[3*k+0],x.y=T.scl[3*k+1],x.z=T.scl[3*k+2],x.multiplyInPlace(E),W=Math.max(Math.abs(1-x.x),Math.abs(1-x.y),Math.abs(1-x.z)),D=Math.max(D,W),T.rel_pos[3*k+0]=b.x,T.rel_pos[3*k+1]=b.y,T.rel_pos[3*k+2]=b.z,T.rel_scl[3*k+0]=x.x,T.rel_scl[3*k+1]=x.y,T.rel_scl[3*k+2]=x.z,T.rel_rot[4*k+0]=w.x,T.rel_rot[4*k+1]=w.y,T.rel_rot[4*k+2]=w.z,T.rel_rot[4*k+3]=w.w;!0===o.options.removeConstAnimationTracks.value&&(B<1e-4&&(T.pos=new Float32Array,T.rel_pos=new Float32Array),O<.05&&(T.rot=new Float32Array,T.rel_rot=new Float32Array),D<.5&&(T.scl=new Float32Array,T.rel_scl=new Float32Array))}return l}static createFromLabels(e,t,r,n,a){if(!e)return a.log.write("No skeleton present, no animation data generated.",i.Warning),[];for(var s=[],o=0;o<r.length;++o){var l=r[o],c=je.create(e,t,l.begin,l.end,l.fps||n,a);null!==c&&(c.name=l.name,s.push(c))}return s}}class ze{constructor(){this.collada=[],this.converter=[]}register(e,t){this.collada.push(e),this.converter.push(t)}findConverter(e){for(var t=0;t<this.collada.length;++t)if(this.collada[t]===e)return this.converter[t];return null}findCollada(e){for(var t=0;t<this.collada.length;++t)if(this.converter[t]===e)return this.collada[t];return null}}class Je extends o{constructor(e,t){super(e),this.log=e,this.options=t,this.materials=new ze,this.textures=new ze,this.nodes=new ze,this.animationTargets=new ze,this.messageCount={}}}class Xe{constructor(e){this.id=e.id,this.url=""}static createTexture(e,t){if(!e||!e.textureSampler)return null;var r=O.fromLink(e.textureSampler,t);if(!r)return t.log.write("Texture sampler not found, texture will be missing",i.Warning),null;var n=r.sampler;if(!n)return t.log.write("Texture sampler param has no sampler, texture will be missing",i.Warning),null;var a=null;if(null!=n.image){if(!(a=J.fromLink(n.image,t)))return t.log.write("Texture image not found, texture will be missing",i.Warning),null}else if(null!=n.surface){var s=O.fromLink(n.surface,t);if(!s)return t.log.write("Texture surface not found, texture will be missing",i.Warning),null;var o=s.surface;if(!o)return t.log.write("Texture surface param has no surface, texture will be missing",i.Warning),null;if(!(a=J.fromLink(o.initFrom,t)))return t.log.write("Texture image not found, texture will be missing",i.Warning),null}var l=t.textures.findConverter(a);return l||((l=new Xe(a)).url=a.initFrom,!0===t.options.removeTexturePath.value&&(l.url=l.url.replace(/^.*[\\\/]/,"")),t.textures.register(a,l),l)}}class He{constructor(){this.symbols={}}}class Qe{constructor(){this.name=null,this.diffuse=null,this.specular=null,this.normal=null,this.diffuseColor=null,this.specularColor=null,this.emissiveColor=null}static createDefaultMaterial(e){var t=e.materials.findConverter(null);return t||(t=new Qe,e.materials.register(void 0,t),t)}static createMaterial(e,t){var r=Y.fromLink(e.material,t);if(!r)return t.log.write("Material not found, material skipped.",i.Warning),Qe.createDefaultMaterial(t);var n=R.fromLink(r.effect,t);if(!n)return t.log.write("Material effect not found, using default material",i.Warning),Qe.createDefaultMaterial(t);var a=n.technique;if(!a)return t.log.write("Material effect not found, using default material",i.Warning),Qe.createDefaultMaterial(t);var s=t.materials.findConverter(r);return s||((s=new Qe).name=r.id,null!=a.diffuse&&null!=a.diffuse.color?s.diffuseColor=Array.prototype.slice.call(a.diffuse.color):s.diffuse=Xe.createTexture(a.diffuse,t),null!=a.specular&&null!=a.specular.color?s.specularColor=Array.prototype.slice.call(a.specular.color):s.specular=Xe.createTexture(a.specular,t),null!=a.emission&&null!=a.emission.color&&(s.emissiveColor=Array.prototype.slice.call(a.emission.color)),s.normal=Xe.createTexture(a.bump,t),t.materials.register(r,s),s)}static getMaterialMap(e,t){for(var r=new He,n=0;n<e.length;n++){var a=e[n],s=a.symbol;s?null==r.symbols[s]?r.symbols[s]=Qe.createMaterial(a,t):t.log.write("Material symbol "+s+" used multiple times",i.Error):t.log.write("Material instance has no symbol, material skipped.",i.Warning)}return r}}class Ke{constructor(){this.min=new s.Vector3,this.max=new s.Vector3,this.reset()}reset(){this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0)}fromPositions(e,t,r){this.reset();for(var n=0;n<r;++n){var a=e[3*(t+n)+0];this.min.x=Math.min(this.min.x,a),this.max.x=Math.max(this.max.x,a),a=e[3*(t+n)+1],this.min.y=Math.min(this.min.y,a),this.max.y=Math.max(this.max.y,a),a=e[3*(t+n)+2],this.min.z=Math.min(this.min.z,a),this.max.z=Math.max(this.max.z,a)}}extend(e){this.min.x=Math.min(this.min.x,e.x),this.max.x=Math.max(this.max.x,e.x),this.min.y=Math.min(this.min.y,e.y),this.max.y=Math.max(this.max.y,e.y),this.min.z=Math.min(this.min.z,e.z),this.max.z=Math.max(this.max.z,e.z)}extendBox(e){this.extend(e.max),this.extend(e.min)}}class Ye{constructor(){this.indices=new Uint32Array,this.position=new Float32Array,this.normal=new Float32Array,this.texcoord=new Float32Array,this.boneweight=new Float32Array,this.boneindex=new Uint8Array}}class Ze{constructor(){this.indices=new Uint32Array,this.indexStride=0,this.indexOffset=0}}class $e{constructor(){this.name="",this.vertexCount=0,this.triangleCount=0,this.vertexBufferOffset=0,this.indexBufferOffset=0,this.data=new Ye,this.material=new Qe,this.boundingBox=new Ke,this.bindShapeMatrix=new s.Matrix,this._colladaIndices=new Ze}static createChunk(e,t,r){if(t?.inputs){for(var n,a,s,o=[],l=0;l<t.inputs.length;l++)switch((v=t.inputs[l]).semantic){case"VERTEX":n=v;break;case"NORMAL":a=v;break;case"COLOR":s=v;break;case"TEXCOORD":o.push(v);break;default:r.log.write("Unknown triangles input semantic "+v.semantic+" ignored",i.Warning)}if(n&&n.source){var c=q.fromLink(n.source,r);if(c){var u=y.fromLink(null!=a?a.source:void 0,r),d=y.fromLink(null!=s?s.source:void 0,r),h=o.map((e=>y.fromLink(null!=e?e.source:void 0,r))),m=null,p=null,g=null,f=[];for(l=0;l<c.inputs.length;l++){var v;switch((v=c.inputs[l]).semantic){case"POSITION":m=v;break;case"NORMAL":p=v;break;case"COLOR":g=v;break;case"TEXCOORD":f.push(v);break;default:r.log.write("Unknown vertices input semantic "+v.semantic+" ignored",i.Warning)}}if(m&&m.source){var b=y.fromLink(m.source,r);if(b){var w=y.fromLink(null!=p?p.source:void 0,r),x=y.fromLink(null!=g?g.source:void 0,r),k=f.map((e=>y.fromLink(null!=e?e.source:void 0,r))),A=Ce(b,"vertex position",3,r),C=Ce(w,"vertex normal",3,r),S=Ce(u,"vertex normal (indexed)",3,r),T=(Ce(x,"vertex color",4,r),Ce(d,"vertex color (indexed)",4,r),k.map((e=>Ce(e,"texture coordinate",2,r)))),_=h.map((e=>Ce(e,"texture coordinate (indexed)",2,r)));if("triangles"!==t.type){var N=t.vcount;if(N){for(l=0;l<N.length;l++)if(3!==N[l])return void r.log.write("Geometry "+e.id+" has non-triangle polygons, geometry ignored.",i.Warning)}else r.log.write("Geometry "+e.id+" has polygons with an unknown number of vertices per polygon. Assuming all triangles.",i.Warning)}if(3===b.stride){var M=t.indices,U=t.count,F=M.length/t.count/3,E=function(e,t,r){for(var n=e.length/t,a=new Uint32Array(n),i=16777215,s=0;s<n;++s){for(var o=i,l=0;l<s;++l)if(e[l*t+r]===e[s*t+r]){o=l;break}a[s]=o}var c=new Uint32Array(n),u=0;for(s=0;s<n;++s)(o=a[s])===i?(c[s]=u,u++):c[s]=c[o];return c}(M,F,n.offset);if(E&&0!==E.length){var L=function(e){if(!e)return 0;for(var t=-1,r=e.length,n=0;n<r;++n)e[n]>t&&(t=e[n]);return t}(E)+1,I=E.length/3;if(I===U){var W=new Float32Array(3*L),B=n.offset;Ae(A,M,F,B,3,W,E,1,0,3);var O=new Float32Array(3*L),D=null!==a?a?.offset:null;null!==C?Ae(C,M,F,B,3,O,E,1,0,3):null!==S?Ae(S,M,F,D,3,O,E,1,0,3):r.log.write("Geometry "+e.id+" has no normal data, using zero vectors",i.Warning);var P=new Float32Array(2*L),R=o.length>0?o[0].offset:null;T.length>0?Ae(T[0],M,F,B,2,P,E,1,0,2):_.length>0?Ae(_[0],M,F,R,2,P,E,1,0,2):r.log.write("Geometry "+e.id+" has no texture coordinate data, using zero vectors",i.Warning);var G=new Ye;G.indices=E,G.position=W,G.normal=O,G.texcoord=P;var V=new Ze;V.indices=M,V.indexStride=F,V.indexOffset=B;var j=new $e;return j.vertexCount=L,j.vertexBufferOffset=0,j.triangleCount=I,j.indexBufferOffset=0,j.data=G,j._colladaIndices=V,j}r.log.write("Geometry "+e.id+" has an inconsistent number of indices, geometry ignored",i.Error)}else r.log.write("Geometry "+e.id+" does not contain any indices, geometry ignored",i.Error)}else r.log.write("Geometry "+e.id+" vertex positions are not 3D vectors, geometry ignored",i.Warning)}else r.log.write("Geometry "+e.id+" has no vertex positions, geometry ignored",i.Warning)}}else r.log.write("Geometry "+e.id+" has no vertices, geometry ignored",i.Warning)}}}static computeBoundingBox(e,t){e.boundingBox.fromPositions(e.data.position,e.vertexBufferOffset,e.vertexCount)}static transformEachVector(e,t){let r=new s.Vector3;for(let n=0;n<e.length;n+=3)r.set(e[n],e[n+1],e[n+2]),s.Vector3.TransformCoordinates(r,t),e[n]=r.x,e[n+1]=r.y,e[n+2]=r.z}static transformChunk(e,t,r,n){var a=e.data.position;null!==a&&$e.transformEachVector(a,t);var i=e.data.normal;null!==i&&$e.transformEachVector(i,r)}static scaleChunk(e,t,r){var n=e.data.position;if(null!==n)for(var a=0;a<n.length;++a)n[a]=n[a]*t}static mergeChunkData(e,t){if(!(e.length<2)){for(var r=0,n=0,a=e.length>0,i=e.length>0,s=e.length>0,o=e.length>0,l=e.length>0,c=0;c<e.length;++c){var u=(p=e[c]).data;r+=p.vertexCount,n+=p.triangleCount,a=a&&null!==u.position,i=i&&null!==u.normal,s=s&&null!==u.texcoord,o=o&&null!==u.boneweight,l=l&&null!==u.boneindex}var d=new Ye;d.indices=new Uint32Array(3*n),a&&(d.position=new Float32Array(3*r)),i&&(d.normal=new Float32Array(3*r)),s&&(d.texcoord=new Float32Array(2*r)),l&&(d.boneindex=new Uint8Array(4*r)),o&&(d.boneweight=new Float32Array(4*r));var h=0,m=0;for(c=0;c<e.length;++c){u=(p=e[c]).data;for(var p,g=0;g<3*p.triangleCount;++g)d.indices[h+g]=u.indices[g+p.indexBufferOffset]+m;a&&Le(u.position,3*p.vertexBufferOffset,d.position,3*m,3*p.vertexCount),i&&Le(u.normal,3*p.vertexBufferOffset,d.normal,3*m,3*p.vertexCount),s&&Le(u.texcoord,2*p.vertexBufferOffset,d.texcoord,2*m,2*p.vertexCount),o&&Le(u.boneweight,4*p.vertexBufferOffset,d.boneweight,4*m,4*p.vertexCount),l&&Le(u.boneindex,4*p.vertexBufferOffset,d.boneindex,4*m,4*p.vertexCount),p.data=d,p.vertexBufferOffset=m,p.indexBufferOffset=h,m+=p.vertexCount,h+=3*p.triangleCount}}}}class et{constructor(e){this.invBindMatrix=s.Matrix.Identity(),this.node=e,this.name=e.name||"",this.attachedToSkin=!1}clone(){var e=new et(this.node);return e.name=this.name,e.parent=this.parent,e.invBindMatrix=this.invBindMatrix.clone(),e.attachedToSkin=this.attachedToSkin,e}depth(){return this.parent?this.parent.depth()+1:0}static create(e){return new et(e)}static findBoneNode(e,t,r){for(var n=void 0,a=[],s=0;s<t.length;s++){var o=t[s],l=e.split("/"),c=p.findSidTarget(e,o,l,r);if(null!=c.result){n=c.result;break}c.warning&&a.push(c.warning)}return n?r.isInstanceOf(n,"VisualSceneNode")?n:void r.log.write("Joint "+e+" does not point to a visual scene node, joint ignored",i.Warning):void r.log.write("Joint with SID "+e+" not found, joint ignored. Related warnings:\n"+a.join("\n"),i.Warning)}static sameInvBindMatrix(e,t,r){if(!e||!t)return!1;for(var n=0;n<16;++n){var a=e.invBindMatrix.asArray()[n],i=t.invBindMatrix.asArray()[n];if(Math.abs(a-i)>r)return!1}return!0}static safeToMerge(e,t){return!(e!==t&&(!e||!t||e.node!==t.node||e.attachedToSkin&&t.attachedToSkin&&!et.sameInvBindMatrix(e,t,1e-5)))}static mergeBone(e,t){if(et.safeToMerge(e,t))return e.attachedToSkin?e.clone():t.attachedToSkin?t.clone():e.clone()}}class tt{constructor(e){this.bones=e}static findBone(e,t){for(var r=0;r<e.length;++r)if(et.safeToMerge(e[r],t))return e[r];return null}static findParent(e,t){if(!t.parent)return null;for(var r=0;r<e.length;++r)if(e[r].node===t.parent.node)return e[r];return null}static checkConsistency(e,t){e.bones&&(e.bones.forEach(((t,r)=>{e.bones.forEach(((e,n)=>{if(r!==n&&et.safeToMerge(t,e))throw new Error("Duplicate bone")}))})),e.bones.forEach((e=>{if(e.parent&&!e.node.parent)throw new Error("Missing parent")})),e.bones.forEach((t=>{if(t.parent&&-1===e.bones.indexOf(t.parent))throw new Error("Invalid parent")})))}static createFromSkin(e,t,r,n,a){for(var s=[],o=0;o<e.length;o++){var l=e[o],c=et.findBoneNode(l,t,a);if(!c)return a.log.write("Joint "+l+" not found for skeleton, no bones created",i.Warning),new tt([]);var u=a.nodes.findConverter(c);if(!u)return a.log.write("Joint "+l+" not converted for skeleton, no bones created",i.Warning),new tt([]);var d=et.create(u);d.attachedToSkin=!0,Ie(n,o,d.invBindMatrix),s.push(d)}var h=new tt(s);return h=tt.addBoneParents(h,a),tt.checkConsistency(h,a),h}static createFromNode(e,t){t.nodes.findCollada(e);var r=et.create(e);r.invBindMatrix=s.Matrix.Identity(),r.attachedToSkin=!0;var n=new tt([r]);return n=tt.addBoneParents(n,t),tt.checkConsistency(n,t),n}static replaceBone(e,t,r){var n=e.slice(0),a=n[t];return n[t]=r,n.forEach((e=>{e.parent===a&&(e.parent=r)})),n}static mergeBone(e,t){for(var r=0;r<e.length;++r)if(et.safeToMerge(e[r],t)){var n=et.mergeBone(e[r],t);return tt.replaceBone(e,r,n)}var a=e.slice(0),i=t.clone();return a.push(i),i.parent=tt.findParent(a,i),a}static mergeSkeletons(e,t,r){var n=[];e.bones.forEach((e=>{n=tt.mergeBone(n,e)})),t.bones.forEach((e=>{n=tt.mergeBone(n,e)}));var a=new tt(n);return tt.checkConsistency(a,r),a}static getSkeletonRootNodes(e,t){for(var r=[],n=0;n<e.length;n++){var a=e[n],s=se.fromLink(a,t);s?r.push(s):t.log.write("Skeleton root node "+a.getUrl()+" not found, skeleton root ignored",i.Warning)}return 0===r.length&&(t.log.write("Controller has no skeleton, using the whole scene as the skeleton root",i.Warning),r=t.nodes.collada.filter((e=>t.isInstanceOf(e.parent,"VisualScene")))),r}static addBoneParents(e,t){for(var r=e.bones.slice(0),n=0;n<r.length;){var a=r[n];++n;for(var i=0;i<r.length;i++){var s=r[i];if(a.node.parent===s.node){a.parent=s;break}}a.node.parent&&!a.parent&&(a.parent=et.create(a.node.parent),r.push(a.parent))}var o=new tt(r);return tt.checkConsistency(o,t),o}static getBoneIndexMap(e,t){for(var r=new Uint32Array(e.bones.length),n=0;n<e.bones.length;++n){for(var a=e.bones[n],i=-1,s=0;s<t.bones.length;++s){var o=t.bones[s];if(et.safeToMerge(a,o)){i=s;break}}if(i<0){var l=a.name,c=t.bones.map((e=>e.name));throw new Error("Bone "+l+" not found in "+c)}r[n]=i}return r}static sortBones(e,t){var r=e.bones.slice(0);if((r=r.sort(((t,r)=>{var n=t.depth(),a=r.depth();return n!==a?n-a:t.parent!==r.parent&&null!==t.parent?e.bones.indexOf(t.parent)-e.bones.indexOf(r.parent):e.bones.indexOf(t)-e.bones.indexOf(r)}))).length!=e.bones.length||0==tt.bonesSorted(r))throw new Error("Error while sorting bones");var n=new tt(r);return tt.checkConsistency(n,t),n}static bonesSorted(e){var t=0;return e.forEach((r=>{null!==r.parent&&e.indexOf(r)<e.indexOf(r.parent)&&++t})),0===t}}class rt{constructor(){this.name="",this.chunks=[],this.boundingBox=new Ke}getSkeleton(){return this.skeleton}static createStatic(e,t,r){if(e&&e.geometry){var n=j.fromLink(e.geometry,r);if(n){var a=rt.createGeometry(n,e.materials,r);return r.options.createSkeleton.value&&rt.addSkeleton(a,t,r),a}r.log.write("Geometry instance has no geometry, mesh ignored",i.Warning)}}static createAnimated(e,t,r){if(e&&e.controller){var n=L.fromLink(e.controller,r);if(n)return null!==n.skin?rt.createSkin(e,n,r):null!==n.morph?rt.createMorph(e,n,r):void 0;r.log.write("Controller instance has no controller, mesh ignored",i.Warning)}}static createSkin(e,t,r){if(e&&e.controller)if(t=L.fromLink(e.controller,r)){var n=t.skin;if(n&&n.source){var a=j.fromLink(n.source,r);if(a){var o=rt.createGeometry(a,e.materials,r);if(!r.options.createSkeleton.value)return r.log.write("Geometry "+o.name+" contains skinning data, but the creation of skeletons is disabled in the options. Using static geometry only.",i.Warning),o;var l=rt.getSkeletonRootNodes(e.skeletons,r);if(0===l.length)return r.log.write("Controller still has no skeleton, using unskinned geometry",i.Warning),o;var c=n.joints;if(!c)return r.log.write("Skin has no joints element, using unskinned mesh",i.Warning),o;var u=c.joints;if(!u||!u.source)return r.log.write("Skin has no joints input, using unskinned mesh",i.Warning),o;var d=y.fromLink(u.source,r);if(!d)return r.log.write("Skin has no joints source, using unskinned mesh",i.Warning),o;var h=d.data,m=new s.Matrix;null!==n.bindShapeMatrix&&Ie(n.bindShapeMatrix,0,m);var p=c?.invBindMatrices;if(!p||!p.source)return r.log.write("Skin has no inverse bind matrix input, using unskinned mesh",i.Warning),o;var g=y.fromLink(p.source,r);if(!g)return r.log.write("Skin has no inverse bind matrix source, using unskinned mesh",i.Warning),o;if(!g.data||!d.data||g.data.length!==16*d.data.length)return r.log.write("Skin has an inconsistent length of joint data sources, using unskinned mesh",i.Warning),o;if(!(g.data instanceof Float32Array))return r.log.write("Skin inverse bind matrices data does not contain floating point data, using unskinned mesh",i.Warning),o;var f=g.data,v=n.vertexWeights;if(!v)return r.log.write("Skin contains no bone weights element, using unskinned mesh",i.Warning),o;var b=v.weights;if(!b||!b.source)return r.log.write("Skin contains no bone weights input, using unskinned mesh",i.Warning),o;var w=y.fromLink(b.source,r);if(!w)return r.log.write("Skin has no bone weights source, using unskinned mesh",i.Warning),o;if(!(w.data instanceof Float32Array))return r.log.write("Bone weights data does not contain floating point data, using unskinned mesh",i.Warning),o;var x=w.data;if(n?.vertexWeights?.joints?.source?.url!==n?.joints?.joints?.source?.url)return r.log.write("Skin uses different data sources for joints in <joints> and <vertex_weights>, this is not supported. Using unskinned mesh.",i.Warning),o;var k=tt.createFromSkin(h,l,m,f,r);if(0===k.bones.length)return r.log.write("Skin contains no bones, using unskinned mesh",i.Warning),o;rt.setSkeleton(o,k,r);for(var A=rt.compactSkinningData(n,x,4,r),C=A.indices,S=A.weights,T=0;T<o.chunks.length;++T){var _=(M=o.chunks[T]).data,N=M._colladaIndices;_.boneindex=new Uint8Array(4*M.vertexCount),Ae(C,N.indices,N.indexStride,N.indexOffset,4,_.boneindex,_.indices,1,0,4),_.boneweight=new Float32Array(4*M.vertexCount),Ae(S,N.indices,N.indexStride,N.indexOffset,4,_.boneweight,_.indices,1,0,4)}for(T=0;T<o.chunks.length;++T){var M;(M=o.chunks[T]).bindShapeMatrix=new s.Matrix,M.bindShapeMatrix.copyFrom(m)}return!0===r.options.applyBindShape.value&&rt.applyBindShapeMatrices(o,r),r.options.sortBones.value&&(k=tt.sortBones(k,r)),rt.setSkeleton(o,k,r),o}r.log.write("Controller has no geometry, mesh ignored",i.Error)}else r.log.write("Controller has no skin, mesh ignored",i.Error)}else r.log.write("Controller instance has no controller, mesh ignored",i.Error)}static compactSkinningData(e,t,r,n){var a=e.vertexWeights?.v,s=e.vertexWeights?.vcount,o=s?.length||0,l=new Float32Array(o*r),c=new Uint8Array(o*r);if(!s||!a)return{weights:l,indices:c};for(var u=0,d=0,h=0,m=new Float32Array(32),p=0;p<o;++p){var g=s[p];g>r&&d++,m[Math.min(g,m.length-1)]++;for(var f=0;f<g;++f){var v=a[u],b=a[u+1];u+=2,Te(c,l,v,t[b],p*r,p*r+r-1)}var w=0;for(f=0;f<r;++f)w+=l[p*r+f];if(w<1e-6||w>1e6)h++;else for(f=0;f<g;++f)l[p*r+f]/=w}return d>0&&n.log.write(d+" vertices are influenced by too many bones, some influences were ignored. Only "+r+" bones per vertex are supported.",i.Warning),h>0&&n.log.write(h+" vertices have zero or infinite total weight, skin will be broken.",i.Warning),{weights:l,indices:c}}static getSkeletonRootNodes(e,t){for(var r=[],n=0;n<e.length;n++){var a=e[n],s=se.fromLink(a,t);s?r.push(s):t.log.write("Skeleton root node "+a.getUrl()+" not found, skeleton root ignored",i.Warning)}return 0===r.length&&(t.log.write("Controller has no skeleton, using the whole scene as the skeleton root",i.Warning),r=t.nodes.collada.filter((e=>t.isInstanceOf(e.parent,"VisualScene")))),r}static createMorph(e,t,r){r.log.write("Morph animated meshes not supported, mesh ignored",i.Warning)}static createGeometry(e,t,r){var n=Qe.getMaterialMap(t,r),a=new rt;a.name=e.name||e.id||e.sid||"geometry";for(var s=e.triangles,o=0;o<s.length;o++){var l,c=s[o];null!==c.material?(l=n.symbols[c.material])||(r.log.write("Material symbol "+c.material+" has no bound material instance, using default material",i.Warning),l=Qe.createDefaultMaterial(r)):(r.log.write("Missing material index, using default material",i.Warning),l=Qe.createDefaultMaterial(r));var u=$e.createChunk(e,c,r);u&&(u.name=a.name,s.length>1&&(u.name+=" #"+o),u.material=l,a.chunks.push(u))}return a}static transformGeometry(e,t,r){var n=new s.Matrix;t.toNormalMatrix(n);for(var a=0;a<e.chunks.length;++a){var i=e.chunks[a];$e.transformChunk(i,t,n,r)}}static setupWorldTransform(e,t){e.skeleton&&e.skeleton?.bones.forEach((e=>{if(t.options.worldTransformBake&&(e.invBindMatrix=e.invBindMatrix.multiply(function(e){var t=Ne(e);return t.copyFrom(Ee(e)),t.invert(),Me}(t))),t.options.worldTransformUnitScale){var r=s.Matrix.Invert(e.node.transformation_post);e.invBindMatrix=r.multiply(e.invBindMatrix)}}))}static scaleGeometry(e,t,r){for(var n=0;n<e.chunks.length;++n){var a=e.chunks[n];$e.scaleChunk(a,t,r)}e.skeleton&&e.skeleton.bones&&e.skeleton.bones.forEach((e=>{e.invBindMatrix[12]*=t,e.invBindMatrix[13]*=t,e.invBindMatrix[14]*=t}))}static applyBindShapeMatrices(e,t){for(var r=0;r<e.chunks.length;++r){var n=e.chunks[r],a=n.bindShapeMatrix;if(a){var i=new s.Matrix;a.toNormalMatrix(i),$e.transformChunk(n,a,i,t),n.bindShapeMatrix=s.Matrix.Identity()}}}static computeBoundingBox(e,t){e.boundingBox.reset();for(var r=0;r<e.chunks.length;++r){var n=e.chunks[r];$e.computeBoundingBox(n,t),e.boundingBox.extendBox(n.boundingBox)}}static addSkeleton(e,t,r){var n=tt.createFromNode(t,r);rt.setSkeleton(e,n,r);for(var a=0;a<e.chunks.length;++a){var i=e.chunks[a],s=i.data;s.boneindex=new Uint8Array(4*i.vertexCount),s.boneweight=new Float32Array(4*i.vertexCount);for(var o=0;o<i.vertexCount;++o)s.boneindex[4*o+0]=0,s.boneindex[4*o+1]=0,s.boneindex[4*o+2]=0,s.boneindex[4*o+3]=0,s.boneweight[4*o+0]=1,s.boneweight[4*o+1]=0,s.boneweight[4*o+2]=0,s.boneweight[4*o+3]=0}r.options.sortBones.value&&(n=tt.sortBones(n,r)),rt.setSkeleton(e,n,r)}static mergeGeometries(e,t){if(0!==e.length){if(1===e.length)return e[0];var r=new rt;r.name="merged_geometry";var n=new tt([]);return e.forEach((e=>{null!==e.skeleton&&(n=tt.mergeSkeletons(n,e.skeleton,t))})),t.options.sortBones.value&&(n=tt.sortBones(n,t)),rt.setSkeleton(r,n,t),e.forEach((e=>{rt.setSkeleton(e,n,t)})),e.forEach((e=>{r.chunks=r.chunks.concat(e.chunks)})),e.forEach((e=>{e.chunks=[]})),r}t.log.write("No geometries to merge",i.Warning)}static setSkeleton(e,t,r){if(e.skeleton)for(var n=tt.getBoneIndexMap(e.skeleton,t),a=0;a<e.chunks.length;++a){var i=e.chunks[a].data.boneindex;if(i)for(var s=0;s<i.length;++s)i[s]=n[i[s]]}e.skeleton=t}}class nt{constructor(e,t,r){this.type="boolean",this.title=e,this.value=t,this.description=r}}class at{constructor(e,t,r,n,a){this.type="number",this.title=e,this.value=t,this.min=r,this.max=n,this.description=a}}class it{constructor(e,t,r,n){this.type="select",this.title=e,this.value=t,this.options=r,this.description=n}}class st{constructor(e,t,r){this.type="array",this.title=e,this.value=t,this.description=r}}class ot{constructor(){this.singleAnimation=new nt("Single animation",!0,"Enabled: all animations are merged into a single animation (useful if each bone has a separate top level animation).<br/>Disabled: animations are not merged."),this.singleGeometry=new nt("Single geometry",!0,"Enabled: all geometries are merged into a single geometry. Only has an effect if 'enableExtractGeometry' is enabled.<br/>Disabled: geometries are not merged."),this.singleBufferPerGeometry=new nt("Single buffer",!1,"Enabled: all chunks within one geometry use one set of vertex buffers, each chunk occupying a different part of the buffer set.<br/>Disabled: each chunk has its own set of buffers."),this.enableAnimations=new nt("Animations",!0,"Enabled: animations are exported.<br/>Disabled: all animations are ignored."),this.enableExtractGeometry=new nt("Extract geometry",!0,"Enabled: extract all geometries from the scene and detach them from their scene graph nodes.<br/>Disabled: geometries remain attached to nodes."),this.enableResampledAnimations=new nt("Resampled animations",!0,"Enabled: generate resampled animations for all skeleton bones.<br/>Disabled: do not generate resampled animations."),this.useAnimationLabels=new nt("Animation labels",!1,"Enabled: animations labels are used to split the global animation into separete animations.<br/>Disabled: only one global animation is exported."),this.animationLabels=new st("Animation labels",[],"An array of animation labels ({name, begin, end, fps)} that describes how the global animation is split.<br/>Only has an effect if 'useAnimationLabels' is enabled."),this.animationFps=new at("Animation samples per second",10,0,100,"Default FPS for resampled animations."),this.removeConstAnimationTracks=new nt("Remove static animations",!0,"Enabled: animation tracks are removed if they only contain the rest pose transformation for all times.<br/>Disabled: all animation tracks are exported."),this.applyBindShape=new nt("Apply bind shape",!0,"Enabled: the positions and normals of skin-animated meshes are pre-multiplied by the bind shape matrix.<br/>Disabled: the bind shape matrix needs to be manually exported and applied during rendering."),this.removeTexturePath=new nt("Remove texture path",!0,"Enabled: only the filename and extension of textures are kept and the remaining path is discarded.<br/>Disabled: original texture paths are kept."),this.sortBones=new nt("Sort bones",!0,"Enabled: bones are sorted so that child bones always appear after their parent bone in the list of bones.<br/>Disabled: bones appear in their original order."),this.worldTransform=new nt("World transform",!1,"Enabled: all objects (geometries, animations, skeletons) are transformed as specified by the corresponding world transform options.<br/>Disabled: the world transform options are ignored."),this.worldTransformBake=new nt("Bake world transform",!0,"Enabled: the world transformation is applied to skinned geometry.<br/>Disabled: the world transformation is applied to the bones."),this.worldTransformUnitScale=new nt("World transform no node scale",!0,"If enabled, the world scale will not add any scaling transformation to any nodes.The world scale will instead be distributed to the translation part of all local transformations."),this.worldTransformScale=new at("World transform: scale",1,1e-6,1e6,"Scale factor. See the 'worldTransform' option."),this.worldTransformRotationAxis=new it("World transform: rotation axis","none",["none","x","y","z"],"Rotation axis. See the 'worldTransform' option."),this.worldTransformRotationAngle=new at("World transform: rotation angle",0,0,360,"Rotation angle (in degrees). See the 'worldTransform' option."),this.truncateResampledAnimations=new nt("Truncate resampled animations",!0,"Enabled: animation durations are truncated in order to keep the requested FPS.<br/>Disabled: requested FPS is slightly modified to keep the original duration."),this.createSkeleton=new nt("Generate skeleton",!0,"Enabled: a skeleton is generated and all geometry is attached to skeleton bones.<br/>Disabled: no skeleton is generated and all geometry is static.")}}!function(e){e[e.Translation=1]="Translation",e[e.Rotation=2]="Rotation",e[e.Scale=3]="Scale"}(Ue||(Ue={}));class lt{constructor(e,t,r){this.rows=t,this.colums=r,this.channels=[];var n=t*r;this.data=new Float32Array(n),this.original_data=new Float32Array(n);for(var a=0;a<n;++a)this.data[a]=e.data[a],this.original_data[a]=e.data[a]}getTargetDataRows(){return this.rows}getTargetDataColumns(){return this.colums}applyAnimation(e,t,r){De?.applyToData(e,this.data,t,r),this.updateFromData()}registerAnimation(e){this.channels?.push(e)}isAnimated(){return!!this.channels&&this.channels.length>0}isAnimatedBy(e){if(null!==e&&this.channels){for(var t=0;t<this.channels.length;++t){var r=this.channels[t];if(-1!==e.channels.indexOf(r))return!0}return!1}return!!this.channels&&this.channels.length>0}resetAnimation(){for(var e=0;e<this.data.length;++e)this.data[e]=this.original_data[e];this.updateFromData()}applyTransformation(e){throw new Error("Not implemented")}updateFromData(){throw new Error("Not implemented")}hasTransformType(e){throw new Error("Not implemented")}}class ct extends lt{constructor(e){super(e,4,4),this.matrix=new s.Matrix,this.updateFromData()}updateFromData(){Ie(this.data,0,this.matrix)}applyTransformation(e){e.copyFrom(e.multiply(this.matrix))}hasTransformType(e){return!0}}class ut extends lt{constructor(e){super(e,4,1),this.axis=new s.Vector3,this.axis=new s.Vector3,this.radians=0,this.updateFromData()}updateFromData(){this.axis.set(this.data[0],this.data[1],this.data[2]),this.radians=this.data[3]/180*Math.PI}applyTransformation(e){let t=s.Matrix.RotationAxis(this.axis,this.radians);e.copyFrom(e.multiply(t))}hasTransformType(e){return e===Ue.Rotation}}class dt extends lt{constructor(e){super(e,3,1),this.pos=new s.Vector3,this.updateFromData()}updateFromData(){this.pos.set(this.data[0],this.data[1],this.data[2])}applyTransformation(e){let t=s.Matrix.Translation(this.pos.x,this.pos.y,this.pos.z);e.copyFrom(e.multiply(t))}hasTransformType(e){return e===Ue.Translation}}class ht extends lt{constructor(e){super(e,3,1),this.scl=new s.Vector3,this.updateFromData()}updateFromData(){this.scl.set(this.data[0],this.data[1],this.data[2])}applyTransformation(e){let t=s.Matrix.Scaling(this.scl.x,this.scl.y,this.scl.z);e.copyFrom(e.multiply(t))}hasTransformType(e){return e===Ue.Scale}}class mt{constructor(){this.transformation_pre=new s.Matrix,this.transformation_post=new s.Matrix,this.matrix=new s.Matrix,this.worldMatrix=new s.Matrix,this.initialLocalMatrix=new s.Matrix,this.initialWorldMatrix=new s.Matrix,this.name="",this.children=[],this.geometries=[],this.transformations=[],this.transformation_pre=s.Matrix.Identity(),this.transformation_post=s.Matrix.Identity()}addTransform(e){var t=new ie;t.data=new Float32Array,e.copyToArray(t.data),t.type="matrix",t.name="virtual static transform";var r=new ct(t);this.transformations.unshift(r)}getWorldMatrix(e){return null!=this.parent?this.worldMatrix=this.parent.getWorldMatrix(e).multiply(this.getLocalMatrix(e)):this.worldMatrix.copyFrom(this.getLocalMatrix(e)),this.worldMatrix}getLocalMatrix(e){this.matrix.copyFrom(this.transformation_pre);for(var t=0;t<this.transformations.length;t++)this.transformations[t].applyTransformation(this.matrix);return this.matrix=this.matrix.multiply(this.transformation_post),this.matrix}containsSceneGraphItems(){return this.geometries.length>0}isAnimated(e){return this.isAnimatedBy(void 0,e)}isAnimatedBy(e,t){for(var r=0;r<this.transformations.length;r++)if(this.transformations[r].isAnimatedBy(e))return!0;return!(!t||!this.parent)&&this.parent.isAnimatedBy(e,t)}resetAnimation(){for(var e=0;e<this.transformations.length;e++)this.transformations[e].resetAnimation()}static pruneNodes(e,t){for(var r=0;r<e.length;++r){var n=e[r];mt.pruneNodes(n.children,t)}e=e.filter(((e,t,r)=>e.containsSceneGraphItems()||e.children.length>0))}static createNode(e,t,r){var n=new mt;n.parent=t,t&&t.children.push(n),r.nodes.register(e,n),n.name=e.name||e.id||e.sid||"Unnamed node";for(var a=0;a<e.transformations.length;++a){var s=e.transformations[a],o=null;switch(s.type){case"matrix":o=new ct(s);break;case"rotate":o=new ut(s);break;case"translate":o=new dt(s);break;case"scale":o=new ht(s);break;default:r.log.write("Transformation type "+s.type+" not supported, transform ignored",i.Warning)}null!==o&&(r.animationTargets.register(s,o),n.transformations.push(o))}for(mt.updateInitialMatrices(n,r),a=0;a<e.children.length;a++){var l=e.children[a];mt.createNode(l,n,r)}return n}static updateInitialMatrices(e,t){e.getLocalMatrix(t),e.initialLocalMatrix.copyFrom(e.matrix),e.getWorldMatrix(t),e.initialWorldMatrix.copyFrom(e.worldMatrix)}static createNodeData(e,t){for(var r=t.nodes.findCollada(e),n=0;n<r.geometries.length;n++){var a=r.geometries[n],s=rt.createStatic(a,e,t);e.geometries.push(s)}for(n=0;n<r.controllers.length;n++){var o=r.controllers[n];s=rt.createAnimated(o,e,t),e.geometries.push(s)}for(r.lights.length>0&&t.log.write("Node "+r.id+" contains lights, lights are ignored",i.Warning),r.cameras.length>0&&t.log.write("Node "+r.id+" contains cameras, cameras are ignored",i.Warning),n=0;n<e.children.length;n++){var l=e.children[n];mt.createNodeData(l,t)}}static forEachNode(e,t){for(var r=0;r<e.length;++r){var n=e[r];t(n),mt.forEachNode(n.children,t)}}static extractGeometries(e,t){var r=[];if(mt.forEachNode(e,(e=>{for(var t=0;t<e.geometries.length;++t)r.push({node:e,geometry:e.geometries[t]});e.geometries=[]})),0===r.length)return t.log.write("No geometry found in the scene, returning an empty geometry",i.Warning),(o=new rt).name="empty_geometry",[o];var n=0,a=0;if(r.forEach((e=>{null!==e.geometry.getSkeleton()&&n++,e.node.isAnimated(!0)&&a++})),t.options.createSkeleton.value||(n>0&&t.log.write("Scene contains "+n+" skinned geometries, but skeleton creation is disabled. Static geometry was generated.",i.Warning),a>0&&t.log.write("Scene contains "+a+" static geometries attached to animated nodes, but skeleton creation is disabled. Static geometry was generated.",i.Warning),r.forEach((e=>{var r=e.node.getWorldMatrix(t);if(t.options.worldTransformUnitScale){var n=new s.Matrix;n=s.Matrix.Invert(e.node.transformation_post),r=r.multiply(n)}rt.transformGeometry(e.geometry,r,t)}))),t.options.singleGeometry){var o,l=r.map((e=>e.geometry));return[o=rt.mergeGeometries(l,t)]}return r.map((e=>e.geometry))}static setupWorldTransform(e,t){var r=function(e){var t=1/e.options.worldTransformScale.value;return new s.Vector3(t,t,t)}(t),n=Ne(t),a=t.options.worldTransformUnitScale.value;null==e.parent?e.transformation_pre.copyFrom(n):a&&(e.transformation_pre=s.Matrix.Invert(e.parent.transformation_post)),a&&(e.transformation_post=s.Matrix.Scaling(r.x,r.y,r.z)),mt.updateInitialMatrices(e,t);for(var i=0;i<e.children.length;++i)mt.setupWorldTransform(e.children[i],t)}}class pt{constructor(){this.nodes=[],this.animations=[],this.geometries=[],this.resampled_animations=[]}}class gt{constructor(){this.log=new c,this.options=new ot}forEachGeometry(e,t){for(var r=0;r<e.geometries.length;++r)t(e.geometries[r]);mt.forEachNode(e.nodes,(e=>{for(var r=0;r<e.geometries.length;++r)t(e.geometries[r])}))}convert(e){var t=new Je(this.log,this.options);if(!e)return t.log.write("No document to convert",i.Warning),null;var r=new pt;if(r.nodes=gt.createScene(e,t),t.options.worldTransform.value){for(var n=0;n<r.nodes.length;++n)mt.setupWorldTransform(r.nodes[n],t);if(this.forEachGeometry(r,(e=>{rt.setupWorldTransform(e,t)})),t.options.worldTransformBake.value){var a=Ne(t);this.forEachGeometry(r,(e=>{null!==e.getSkeleton()&&rt.transformGeometry(e,a,t)}))}}return!0===t.options.enableAnimations.value&&(r.animations=gt.createAnimations(e,t)),!0===t.options.enableExtractGeometry.value&&(r.geometries=mt.extractGeometries(r.nodes,t)),!0===t.options.singleBufferPerGeometry.value&&this.forEachGeometry(r,(e=>{$e.mergeChunkData(e.chunks,t)})),!0===t.options.enableResampledAnimations.value&&(r.resampled_animations=gt.createResampledAnimations(e,r,t)),mt.forEachNode(r.nodes,(e=>{this.forEachGeometry(r,(e=>{rt.computeBoundingBox(e,t)}))})),r}static createScene(e,t){var r=[];if(!e.scene)return t.log.write("Collada document has no scene",i.Warning),r;var n=le.fromLink(e.scene.instance,t);if(!n)return t.log.write("Collada document has no scene",i.Warning),r;for(var a=0;a<n.children.length;++a){var s=n.children[a];r.push(mt.createNode(s,null,t))}for(a=0;a<r.length;++a){var o=r[a];mt.createNodeData(o,t)}return r}static createAnimations(e,t){for(var r=[],n=0;n<e.libAnimations.children.length;++n){var a=e.libAnimations.children[n];r.push(Ge.create(a,t))}if(!0===t.options.singleAnimation.value&&r.length>1){var i=new Ge;for(i.id="",i.name="animation",n=0;n<r.length;++n){var s=r[n];i.channels=i.channels.concat(s.channels),s.channels=[]}r=[i]}return r}static createResampledAnimations(e,t,r){var n=[];if(0===t.animations.length)return[];if(t.geometries.length>1)return r.log.write("Converted document contains multiple geometries, resampled animations are only generated for single geometries.",i.Warning),[];if(0===t.geometries.length)return r.log.write("Converted document does not contain any geometries, no resampled animations generated.",i.Warning),[];for(var a=t.geometries[0],s=+r.options.animationFps.value,o=0;o<t.animations.length;++o){var l=t.animations[o];if(!0===r.options.useAnimationLabels.value){var c=r.options.animationLabels.value,u=je.createFromLabels(a.getSkeleton(),l,c,s,r);n=n.concat(u)}else{var d=je.create(a.getSkeleton(),l,null,null,s,r);null!==d&&n.push(d)}}return n}}class ft extends o{constructor(e){super(e),this.log=e,this.chunks=[],this.chunk_data=[],this.bytes_written=0}registerChunk(e){this.chunks.push(e),e.byte_offset=this.bytes_written,this.bytes_written+=e.getBytesCount()}assembleData(){for(var e=new ArrayBuffer(this.bytes_written),t=new Uint8Array(e),r=0;r<this.chunks.length;++r)for(var n=this.chunks[r],a=n.getDataView(),i=a.length,s=n.byte_offset,o=0;o<i;++o)t[o+s]=a[o];return t}}class vt{static toJSON(e,t){return e?{name:e.name,diffuse:null!==e.diffuse?e.diffuse.url:"",specular:null!==e.specular?e.specular.url:"",normal:null!==e.normal?e.normal.url:"",diffuseColor:e.diffuseColor,specularColor:e.specularColor,emissiveColor:e.emissiveColor}:null}}class bt{constructor(){this.byte_offset=0,this.stride=0,this.count=0,this.bytes_per_element=0,this.data=null}getDataView(){return new Uint8Array(this.data.buffer,0,this.stride*this.count*this.bytes_per_element)}getBytesCount(){return this.data.length*this.bytes_per_element}static toJSON(e){return e&&e.type||(e.type=""),{type:e.type,byte_offset:e.byte_offset,stride:e.stride,count:e.count}}static create(e,t,r){var n=new bt;if(!e)return n;if(n.data=e,n.stride=t,n.count=e.length/t,e instanceof Float32Array)n.type="float",n.bytes_per_element=4;else if(e instanceof Float64Array)n.type="double",n.bytes_per_element=8;else if(e instanceof Uint8Array)n.type="uint8",n.bytes_per_element=1;else if(e instanceof Uint16Array)n.type="uint16",n.bytes_per_element=2;else if(e instanceof Uint32Array)n.type="uint32",n.bytes_per_element=4;else if(e instanceof Int8Array)n.type="int8",n.bytes_per_element=1;else if(e instanceof Int16Array)n.type="int16",n.bytes_per_element=2;else{if(!(e instanceof Int32Array))return r.log.write("Unknown data type, data chunk ignored",i.Warning),n;n.type="int32",n.bytes_per_element=4}return r.registerChunk(n),n}}class wt{static toJSON(e){return e?{min:[e.min[0],e.min[1],e.min[2]],max:[e.max[0],e.max[1],e.max[2]]}:{min:[0,0,0],max:[0,0,0]}}}class xt{static toJSON(e,t,r){var n=bt.create(e.data.indices,3,r),a=bt.create(e.data.position,3,r),i=bt.create(e.data.normal,3,r),s=bt.create(e.data.texcoord,2,r),o=bt.create(e.data.boneweight,4,r),l=bt.create(e.data.boneindex,4,r);return{name:e.name,material:t,vertex_count:e.vertexCount,triangle_count:e.triangleCount,indices:bt.toJSON(n),position:bt.toJSON(a),normal:bt.toJSON(i),texcoord:bt.toJSON(s),boneweight:bt.toJSON(o),boneindex:bt.toJSON(l),bounding_box:wt.toJSON(e.boundingBox)}}}class kt{static toJSON(e,t){if(e){var r=[];return e.bones.forEach((t=>{var n=t.node.initialLocalMatrix,a=new s.Vector3(0,0,0),i=new s.Quaternion(0,0,0,1),o=new s.Vector3(1,1,1);n.decompose(o,i,a);var l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];t.invBindMatrix=s.Matrix.FromArray(l),r.push({name:t.name,parent:e.bones.indexOf(t.parent),skinned:t.attachedToSkin,inv_bind_mat:l,matrix:n.asArray(),pos:a.asArray(),rot:i.asArray(),scl:o.asArray()})})),r}}}class yt{static toJSON(e,t,r){if(!e)return null;var n=bt.create(e.pos,3,r),a=bt.create(e.rot,4,r),i=bt.create(e.scl,3,r);return{bone:t,pos:bt.toJSON(n),rot:bt.toJSON(a),scl:bt.toJSON(i)}}}class At{static toJSON(e,t){return e?{name:e.name,frames:e.keyframes,fps:e.fps,tracks:e.tracks.map(((e,r)=>yt.toJSON(e,r,t)))}:{name:"",frames:0,fps:0,tracks:void 0}}}class Ct{constructor(){this.json=null,this.data=null}}class St{constructor(){this.log=new c}export(e){var t=new ft(this.log);if(!e)return t.log.write("No document to convert",i.Warning),null;if(0===e.geometries.length)return t.log.write("Document contains no geometry, nothing exported",i.Warning),null;e.geometries.length>1&&t.log.write("Document contains multiple geometries, only the first geometry is exported",i.Warning);for(var r=[],n=[],a=e.geometries[0],s=[],o=0;o<a.chunks.length;++o){var l=a.chunks[o],c=r.indexOf(l.material);if(-1===c){var u=vt.toJSON(l.material,t);c=n.length,r.push(l.material),n.push(u)}s.push(xt.toJSON(l,c,t))}var d=new Ct,h={bounding_box:wt.toJSON(a.boundingBox)},m=kt.toJSON(a.getSkeleton(),t),p=e.resampled_animations.map((e=>At.toJSON(e,t)));return d.json={info:h,materials:n,chunks:s,bones:m,animations:p},d.data=t.assembleData(),d}}class Tt{constructor(){this.name="dae",this.extensions=".dae",this._assetContainer=null}createPlugin(){return new Tt}importMeshAsync(e,t,r,n){var a=new de,s=new l;s.onmessage=(e,t)=>{console.log(e)},a.log=new u(s,i.Debug);var o=(new DOMParser).parseFromString(r,"text/xml"),c=a.loadFromXML("id",o),d=(new gt).convert(c),h=(new St).export(d),m=(new we).loadModel(h.json,h.data.buffer),p=(new xe).createBabylonModel(m,t);const g={meshes:p.meshes,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:p.transformNodes||[],geometries:[],lights:[],spriteManagers:[]};return Promise.resolve(g)}loadAsync(e,t,r){return this.importMeshAsync(void 0,e,t,r).then((()=>{}))}loadAssetContainerAsync(e,t,r){const n=new s.AssetContainer(e);return this._assetContainer=n,this.importMeshAsync(void 0,e,t,r).then((e=>(e.meshes.forEach((e=>{n.meshes.push(e)})),e.meshes.forEach((e=>{const t=e.material;t&&-1==n.materials.indexOf(t)&&(n.materials.push(t),t.getActiveTextures().forEach((e=>{-1==n.textures.indexOf(e)&&n.textures.push(e)})))})),this._assetContainer=null,n))).catch((e=>{throw this._assetContainer=null,e}))}}function _t(){s.SceneLoader&&s.SceneLoader.RegisterPlugin(new Tt)}return a})()));
//# sourceMappingURL=dae.js.map