{"version":3,"file":"abstractEngine.cubeTexture-CKwXnzwi.esm.js","sources":["../../../../../dev/core/dist/Engines/AbstractEngine/abstractEngine.cubeTexture.js"],"sourcesContent":["import { InternalTexture } from \"../../Materials/Textures/internalTexture\";\nimport { Logger } from \"../../Misc/logger\";\nimport { LoadImage } from \"../../Misc/fileTools\";\nimport { RandomGUID } from \"../../Misc/guid\";\nimport { AbstractEngine } from \"../abstractEngine\";\nimport { _GetCompatibleTextureLoader } from \"core/Materials/Textures/Loaders/textureLoaderManager\";\nimport { GetExtensionFromUrl } from \"core/Misc/urlTools\";\nAbstractEngine.prototype._partialLoadFile = function (url, index, loadedFiles, onfinish, onErrorCallBack = null) {\n    const onload = (data) => {\n        loadedFiles[index] = data;\n        loadedFiles._internalCount++;\n        if (loadedFiles._internalCount === 6) {\n            onfinish(loadedFiles);\n        }\n    };\n    const onerror = (request, exception) => {\n        if (onErrorCallBack && request) {\n            onErrorCallBack(request.status + \" \" + request.statusText, exception);\n        }\n    };\n    this._loadFile(url, onload, undefined, undefined, true, onerror);\n};\nAbstractEngine.prototype._cascadeLoadFiles = function (scene, onfinish, files, onError = null) {\n    const loadedFiles = [];\n    loadedFiles._internalCount = 0;\n    for (let index = 0; index < 6; index++) {\n        this._partialLoadFile(files[index], index, loadedFiles, onfinish, onError);\n    }\n};\nAbstractEngine.prototype._cascadeLoadImgs = function (scene, texture, onfinish, files, onError = null, mimeType) {\n    const loadedImages = [];\n    loadedImages._internalCount = 0;\n    for (let index = 0; index < 6; index++) {\n        this._partialLoadImg(files[index], index, loadedImages, scene, texture, onfinish, onError, mimeType);\n    }\n};\nAbstractEngine.prototype._partialLoadImg = function (url, index, loadedImages, scene, texture, onfinish, onErrorCallBack = null, mimeType) {\n    const tokenPendingData = RandomGUID();\n    const onload = (img) => {\n        loadedImages[index] = img;\n        loadedImages._internalCount++;\n        if (scene) {\n            scene.removePendingData(tokenPendingData);\n        }\n        if (loadedImages._internalCount === 6 && onfinish) {\n            onfinish(texture, loadedImages);\n        }\n    };\n    const onerror = (message, exception) => {\n        if (scene) {\n            scene.removePendingData(tokenPendingData);\n        }\n        if (onErrorCallBack) {\n            onErrorCallBack(message, exception);\n        }\n    };\n    LoadImage(url, onload, onerror, scene ? scene.offlineProvider : null, mimeType);\n    if (scene) {\n        scene.addPendingData(tokenPendingData);\n    }\n};\nAbstractEngine.prototype.createCubeTextureBase = function (rootUrl, scene, files, noMipmap, onLoad = null, onError = null, format, forcedExtension = null, createPolynomials = false, lodScale = 0, lodOffset = 0, fallback = null, beforeLoadCubeDataCallback = null, imageHandler = null, useSRGBBuffer = false, buffer = null) {\n    const texture = fallback ? fallback : new InternalTexture(this, 7 /* InternalTextureSource.Cube */);\n    texture.isCube = true;\n    texture.url = rootUrl;\n    texture.generateMipMaps = !noMipmap;\n    texture._lodGenerationScale = lodScale;\n    texture._lodGenerationOffset = lodOffset;\n    texture._useSRGBBuffer = !!useSRGBBuffer && this._caps.supportSRGBBuffers && (this.version > 1 || this.isWebGPU || !!noMipmap);\n    if (texture !== fallback) {\n        texture.label = rootUrl.substring(0, 60); // default label, can be overriden by the caller\n    }\n    if (!this._doNotHandleContextLost) {\n        texture._extension = forcedExtension;\n        texture._files = files;\n        texture._buffer = buffer;\n    }\n    const originalRootUrl = rootUrl;\n    if (this._transformTextureUrl && !fallback) {\n        rootUrl = this._transformTextureUrl(rootUrl);\n    }\n    const extension = forcedExtension ?? GetExtensionFromUrl(rootUrl);\n    const loaderPromise = _GetCompatibleTextureLoader(extension);\n    const localOnError = (message, exception) => {\n        // if an error was thrown during load, dispose the texture, otherwise it will stay in the cache\n        texture.dispose();\n        if (onError) {\n            onError(message, exception);\n        }\n        else if (message) {\n            Logger.Warn(message);\n        }\n    };\n    const onInternalError = (request, exception) => {\n        if (rootUrl === originalRootUrl) {\n            if (request) {\n                localOnError(request.status + \" \" + request.statusText, exception);\n            }\n        }\n        else {\n            // fall back to the original url if the transformed url fails to load\n            Logger.Warn(`Failed to load ${rootUrl}, falling back to the ${originalRootUrl}`);\n            this.createCubeTextureBase(originalRootUrl, scene, files, !!noMipmap, onLoad, localOnError, format, forcedExtension, createPolynomials, lodScale, lodOffset, texture, beforeLoadCubeDataCallback, imageHandler, useSRGBBuffer, buffer);\n        }\n    };\n    if (loaderPromise) {\n        // eslint-disable-next-line @typescript-eslint/no-floating-promises, github/no-then\n        loaderPromise.then((loader) => {\n            const onLoadData = (data) => {\n                if (beforeLoadCubeDataCallback) {\n                    beforeLoadCubeDataCallback(texture, data);\n                }\n                loader.loadCubeData(data, texture, createPolynomials, onLoad, (message, exception) => {\n                    localOnError(message, exception);\n                });\n            };\n            if (buffer) {\n                onLoadData(buffer);\n            }\n            else if (files && files.length === 6) {\n                if (loader.supportCascades) {\n                    this._cascadeLoadFiles(scene, (images) => onLoadData(images.map((image) => new Uint8Array(image))), files, localOnError);\n                }\n                else {\n                    localOnError(\"Textures type does not support cascades.\");\n                }\n            }\n            else {\n                this._loadFile(rootUrl, (data) => onLoadData(new Uint8Array(data)), undefined, undefined, true, onInternalError);\n            }\n        });\n    }\n    else {\n        if (!files || files.length === 0) {\n            throw new Error(\"Cannot load cubemap because files were not defined, or the correct loader was not found.\");\n        }\n        this._cascadeLoadImgs(scene, texture, (texture, imgs) => {\n            if (imageHandler) {\n                imageHandler(texture, imgs);\n            }\n        }, files, localOnError);\n    }\n    this._internalTexturesCache.push(texture);\n    return texture;\n};\n//# sourceMappingURL=abstractEngine.cubeTexture.js.map"],"names":[],"mappings":"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"}